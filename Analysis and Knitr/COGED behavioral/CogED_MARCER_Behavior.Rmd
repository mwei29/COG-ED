---
title: "Cog-ED MARCER Behavioral Results"
author: "Mengzhe Wei"
date: "`r Sys.Date()`"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    toc: yes
    toc_float:
      collapsed: true
---
# MARCER_CogEd_data
## Behavioral Session
#### There are 142 participants that have scan session data. 134 participants have COGED data, thus included in these analyses.
#### N.b. all error bars in this summary are 95% CIs
Started by MW in 12/10/24 to analyze MARCER COGED full behavioral data. The last version was CogED_MARCER_Behavior_2023.Rmd made by MW, adapted from JC's COGED PETMR project, for MW's SSM & ADAA projects in 2023.

```{r setup, warning=FALSE, message=FALSE}
rm(list=ls());
#Packages
library(boxr); library(lme4); library(knitr); library(kableExtra); library(correlation); library(RColorBrewer); library(tidyverse);library(boxr);library(readxl);library(psych)
source("summarySEwithin2.R")
box_auth(); 

in.path <- "C:/Users/Emotion/Documents/GIT-MW/COG-ED/Prep/SubjectSet/" 
out.path <-"C:/Users/Emotion/Documents/GIT-MW/COG-ED/Analysis and Knitr/COGED behavioral/" 
dir.desc <- "20250114";  
sub.tbl <- read.table(paste0(in.path, dir.desc, "_subjectSet.txt"), stringsAsFactors=FALSE); #Made from GIT/MARCER/weie/COGED/defineSubjectSet.R
sub.ids <- sub.tbl$sub.id[which(sub.tbl$COGED_CatchNonCatch == TRUE)]
length(sub.ids) # Number of participants included in this analysis
 
# # Load demographic
# demo.tbl <- read_excel(paste0(in.path,"data_per_participant.xlsx")) #https://wustl.app.box.com/file/1566635094447?s=49s7ro9bu7jn4tkvjihc69ut3gikmqc4
# eth.tbl <- read_excel(paste0(in.path,"ethnicity.xlsx")) #based on MARCER master spreadsheet
# demo.tbl <- demo.tbl[demo.tbl$sub.id %in% sub.ids,] # filter only participant with scan data
# demo$sub.id<-as.integer(demo$sub.id)
# eth.tbl$PID<-as.integer(eth.tbl$PID)
# demo <- demo %>%
#   left_join(eth.tbl %>% select(PID, Ethnicity), by = c("sub.id" = "PID"))
# write.csv(demo, "demo.csv", row.names = FALSE)

# # Run the following code if the data sets are not compiled yet #Quick note, follow up 6558 was entered wrong in the data set as 6885. I directly edited it in my compiled dataset instead of changing the raw data. 
# # Load COGED and nback data from box, preprocessed folder 
# tasks <- c("coged.lab","coged.fmri","NASA","nback.lab","nback.fmri")
# task.names <- c("coged-MARCER-","coged-MARCER-fMRI-","followupredcap-MARCER-","nback-MARCER-","scan-nback-MARCER-")
# for (tid in 4:length(tasks)) {
#   assign(tasks[tid], data.frame())
#   print(paste0("Processing task:", tasks[tid]))
#   for (sid in 1:length(sub.ids)) { 
#     print(paste0("Processing sub.id:", sub.ids[sid]))
#     fname <- paste0(task.names[tid],sub.ids[sid], "-converted.csv")
#     fid <- box_search(fname)
#     if (is.null(fid)) {
#       print(paste("File not found for sub.id:", sub.ids[sid], "in task:", tasks[tid]))
#       next
#     }
#     tmp.tbl <- box_read(fid) %>% as.data.frame() # Read in the file and store the data as a dataframe
#     if (tasks[tid] == "NASA") {
#       tmp.tbl <- tmp.tbl[,1:60]
#       tmp.tbl$hbc1 <- as.integer(tmp.tbl$hbc1)
#       tmp.tbl$hbc2 <- as.integer(tmp.tbl$hbc2)
#       tmp.tbl$confience2 <- as.integer(tmp.tbl$confience2)
#     }
#     df <- get(tasks[tid]) # Retrieve the existing data frame
#     df <- bind_rows(df, tmp.tbl) # Append rows to the data frame
#     assign(tasks[tid], df) # Update the data frame in the environment
#   }
#     write.csv(get(tasks[tid]), paste0(tasks[tid], ".csv"), row.names = FALSE)
#   }

demo <- read.csv("demo.csv")
coged.lab<- read.csv("coged.lab.csv")
coged.fmri<- read.csv("coged.fmri.csv")
NASA <- read.csv("NASA.csv")
nback.lab <- read.csv("nback.lab.csv")
nback.fmri <- read.csv("nback.fmri.csv")
```

## Demographic Info

```{r Demo, warning=FALSE, message=FALSE}
#Age
demo %>%
  group_by(Age.Group) %>%
  summarise(total_count=n()) 
demo %>%
  group_by(Age.Group,Age.Bin) %>%
  summarise(total_count=n()) 
describe(demo$Age)
#Gender
demo %>% select(Gender) %>%
  count(Gender)
#MDD status
demo %>% select(MDD_Status) %>%
  count(MDD_Status)
demo %>% 
  group_by(Age.Group,MDD_Status,Gender) %>%
  summarise(total_count=n()) 
#Race
demo %>% select(Race) %>%
  count(Race)
demo %>% 
  group_by(Age.Group,MDD_Status,Race) %>%
  summarise(total_count=n()) 
demo %>% select(Ethnicity) %>%
  count(Ethnicity)
```

### N-Back Performance - in lab

```{r nback, warning=F, message=F}
#Summarizing n-back performance
nback.lab <- left_join(nback.lab, demo %>% 
                       select(sub.id, MDD_Status, Age.Group,Age), 
                       by = c("subID" = "sub.id")) %>% 
  select(subID, level, kind, acc, RT, MDD_Status, Age.Group,Age) %>% 
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
         taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         ageCode = factor (Age.Group, levels = c("MA", "OA"), labels = c(0,1)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure")
nback.lab$taskCode <- as.numeric(as.character(nback.lab$taskCode))
nback.lab$ageCode <- as.numeric(as.character(nback.lab$ageCode))
nback.lab$groupCode <- as.numeric(as.character(nback.lab$groupCode))

#Accuracy - without group; as expected, accuracy goes down as task becomes harder
nback.lab.acc <- glmer(data = nback.lab, acc ~ taskCode + (1 | subID), family = "binomial")
summary(nback.lab.acc)
nback.lab.acc.sum <- summarySEwithin2(nback.lab, measurevar = "acc", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci)) %>% arrange(level)
kable(nback.lab.acc.sum, digits = 3) %>% kable_styling()
#Visualization
p.nback.lab.acc <- ggplot(nback.lab.acc.sum, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") 
p.nback.lab.acc + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#Accuracy - with groups; as expected, age has a negative main effect on accuracy, MDD N.S.
nback.lab.acc.group <- glmer(data = nback.lab, acc ~ taskCode + ageCode + groupCode + (1 | subID), family = "binomial")
summary(nback.lab.acc.group)
nback.lab.acc.sum.group <- summarySEwithin2(nback.lab, measurevar = "acc", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
          rename("trial_type" = kind) %>% 
          select(c(level, trial_type, acc, sd, se, ci, MDD_Status, Age.Group)) %>%
          arrange(level)
p.nback.lab.acc.group <- ggplot(nback.lab.acc.sum.group, aes(x=level, y=acc, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") +
  facet_grid(MDD_Status ~ Age.Group) + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.lab.acc.group

#RT; as expected, RT increases as nback gets harder
nback.lab.RT <- lmer(data = nback.lab, RT ~ taskCode + (1 | subID))
summary(nback.lab.RT)
nback.lab.RT.sum <- summarySEwithin2(nback.lab, measurevar = "RT", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci)) %>% arrange(level)
kable(nback.lab.RT.sum, digits = 3) %>% kable_styling()
#Visualization
p.nback.lab.RT <- ggplot(nback.lab.RT.sum, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)")
p.nback.lab.RT + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#RT - with group
nback.lab.RT.group <- lmer(data = nback.lab, RT ~ taskCode +  ageCode + groupCode + (1 | subID))
summary(nback.lab.RT.group)
nback.lab.RT.sum.group <- summarySEwithin2(nback.lab, measurevar = "RT", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, MDD_Status, Age.Group)) %>% arrange(level)
kable(nback.lab.RT.sum.group, digits = 3) %>% kable_styling()

p.nback.lab.RT.group <- ggplot(nback.lab.RT.sum.group, aes(x=level, y=RT, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)") +
  facet_grid(MDD_Status ~ Age.Group) + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.lab.RT.group
```


## Cognitive Effort Discounting
### In lab SV and RT (Black = 1-back, Red = 2-Back, Blue = 3-back, Purple = 4-back)
We are not seeing an age or MDD effect in SV
```{r SV_CogED, warning=F, message=F}
#clean data frame with Cog-ED SV estimates
coged.lab <- left_join(coged.lab, demo %>%
                       select(sub.id, MDD_Status, Age.Group, Age),
                       by = c("subID" = "sub.id")) %>%
  group_by(subID) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         taskCode = factor(task, levels=c(1,2,3), labels=c(-1,0,1)),
         task = factor(task, levels=c(1,2,3), labels=c("Red","Blue","Purple")))

coged.lab$taskCode <- as.numeric(as.character(coged.lab$taskCode))
coged.lab$ageCode <- as.numeric(as.character(coged.lab$ageCode))
coged.lab$groupCode <- as.numeric(as.character(coged.lab$groupCode))

coged.SV <- coged.lab %>% group_by(subID, task, Age.Group, MDD_Status) %>%
summarise(meanSV = mean(SV))
coged.SV

#testing for differences across task & condition (red, blue, purple). As predicted, SV is discounted with task difficulty
SV <- lmer(data = coged.lab, SV ~ taskCode + (1 | subID))
summary(SV)

#testing for differences across task & condition (red, blue, purple) controlling for age and group
SV.group <- lmer(data = coged.lab, SV ~ taskCode + ageCode + groupCode + (1 | subID))
summary(SV.group)
```

``` {r CogED_SV_Plot, warning = F, message = F}
#summary of data for plotting
coged.lab.sum <- summarySEwithin2(coged.lab, measurevar = "SV", withinvars = c("task","MDD_Status","Age.Group"), idvar = "subID")
#Plotting
p.SV <- ggplot(coged.lab.sum, aes(x=task, y=SV, fill=task, color=task)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = coged.SV, aes(x=task, y=meanSV, color=task),
             stat="identity", alpha=0.7, position = "jitter") +
  coord_cartesian(ylim=c(0,1)) +
  scale_x_discrete(breaks=NULL) +
  xlab("") + ylab("Subjective Value") +
  facet_grid(MDD_Status ~ Age.Group) + 
  scale_fill_brewer(palette = "Set1",  name="Task Effort Level", labels=c("Low","Medium","High")) + scale_color_brewer(palette = "Set1", name="Task Effort Level", labels=c("Low","Medium","High"))
p.SV
#Plotting with participants' lines
p.SV.pt <- ggplot(coged.lab.sum, aes(x=task, y=SV)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = coged.SV, aes(x=task, y=meanSV),
             stat="identity", alpha=0.7) +
  geom_line(data = coged.SV, aes(x=task, y=meanSV, group=subID, colour = factor(subID)), alpha = .5) +
  coord_cartesian(ylim=c(0,1)) +
  xlab("Task") + ylab("Subjective Value") +
  facet_grid(MDD_Status ~ Age.Group)
p.SV.discounting <- p.SV.pt + guides(colour=FALSE)
p.SV.discounting

#summarizing average SV
average.SV <- coged.lab %>% select(subID, SV, MDD_Status, Age.Group) %>%
  group_by(MDD_Status,Age.Group) %>%
  summarise(SV_avg = mean(SV)) 
average.SV
```

## Self-Report Questionnaires
### NASA TLX (administered after each run of the familiarization tasks)

``` {r NASA, warning = F, message = F}
#cleaning up data structures from REDCap
NASA <- NASA %>%
  pivot_longer(cols = c("black_mdemand", "black_pdemand", "black_tdemand", "red_mdemand", "red_pdemand", "red_tdemand", "blue_mdemand", "blue_pdemand", "blue_tdemand","purple_mdemand", "purple_pdemand", "purple_tdemand"), names_to = "condition", values_to = "rating") %>%
  separate(col = condition, into=c("Task","Characteristic"), sep = "_") %>%
  pivot_wider(values_from = rating, names_from = Characteristic) %>%
  rename(mental_demand = mdemand, 
         phsyical_demand = pdemand, 
         temporal_demand = tdemand) %>%
  left_join(demo %>% select(sub.id, MDD_Status, Age.Group, Age), 
            by = c("participant_id" = "sub.id")) 

#Mental Demand Ratings
NASA.demand <- NASA %>% select(participant_id, Task, mental_demand, MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.m.demand = mean(mental_demand)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.demand$taskCode <- as.numeric(as.character(NASA.demand$taskCode))
NASA.demand$ageCode <- as.numeric(as.character(NASA.demand$ageCode))
NASA.demand$groupCode <- as.numeric(as.character(NASA.demand$groupCode))

#Multi-level model (implemented in lme4). As predicted, the more effortful the task is, the more mental demand pt endorses.
mentalDemand <- lmer(mean.m.demand ~ taskCode + (1 | participant_id), data = NASA.demand)
summary(mentalDemand)

mentalDemand.group <- lmer(mean.m.demand ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.demand)
summary(mentalDemand.group)

NASA_mdemand_sum <- summarySEwithin2(NASA.demand, measurevar = "mean.m.demand", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_mdemand_sum$Task <- factor(NASA_mdemand_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.demand <- ggplot(NASA_mdemand_sum, aes(x=Task, y=mean.m.demand)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.m.demand-ci, ymax=mean.m.demand+ci), width=.2) +  
  xlab("Task") + ylab("Mental Demand") + ggtitle("Self-Reported Mental Demand") +
  facet_grid(MDD_Status ~ Age.Group)
p.demand

#Effort Ratings
NASA.effort <- NASA %>% 
  mutate(effort = case_when(
    Task == "black" ~ black_effort,
    Task == "red" ~ red_effort,
    Task == "blue" ~ blue_effort,
    Task == "purple" ~ purple_effort
  )) %>%
  select(participant_id, Task, effort,MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.effort = mean(effort)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.effort$taskCode <- as.numeric(as.character(NASA.effort$taskCode))
NASA.effort$ageCode <- as.numeric(as.character(NASA.effort$ageCode))
NASA.effort$groupCode <- as.numeric(as.character(NASA.effort$groupCode))

#Multi-level model (implemented in lme4)
effort <- lmer(mean.effort ~ taskCode + (1 | participant_id), data = NASA.effort)
summary(effort)
effort.group <- lmer(mean.effort ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.effort)
summary(effort.group)

NASA_effort_sum <- summarySEwithin2(NASA.effort, measurevar = "mean.effort", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_effort_sum$Task <- factor(NASA_effort_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.effort <- ggplot(NASA_effort_sum, aes(x=Task, y=mean.effort)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.effort-ci, ymax=mean.effort+ci), width=.2) +  
  xlab("Task") + ylab("Effort") + ggtitle("Self-Reported Effort") +
  facet_grid(MDD_Status ~ Age.Group)
p.effort

#Frustration Ratings
NASA.frust <- NASA %>% 
  mutate(frustration = case_when(
    Task == "black" ~ black_frustration,
    Task == "red" ~ red_frustration,
    Task == "blue" ~ blue_frustration,
    Task == "purple" ~ purple_frustration
  )) %>%
  select(participant_id, Task, frustration,MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.frust = mean(frustration)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.frust$taskCode <- as.numeric(as.character(NASA.frust$taskCode))
NASA.frust$ageCode <- as.numeric(as.character(NASA.frust$ageCode))
NASA.frust$groupCode <- as.numeric(as.character(NASA.frust$groupCode))
  
#Multi-level model (implemented in lme4)
frust <- lmer(mean.frust ~ taskCode + (1 | participant_id), data = NASA.frust)
summary(frust)

frust.group <- lmer(mean.frust ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.frust)
summary(frust.group)

NASA_frust_sum <- summarySEwithin2(NASA.frust, measurevar = "mean.frust", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_frust_sum$Task <- factor(NASA_frust_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.frust <- ggplot(NASA_frust_sum, aes(x=Task, y=mean.frust)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.frust-ci, ymax=mean.frust+ci), width=.2) +  
  xlab("Task") + ylab("Frustration") + ggtitle("Self-Reported Frustration")+
  facet_grid(MDD_Status ~ Age.Group)
p.frust
```

## fMRI Session
### N-Back Performance

```{r nback_fmri, warning=F, message=F}
#summarizing n-back task performance in the scanner
nback.fmri.clean <- nback.fmri %>% filter(resp != 9) %>%select(subID, level, kind, acc, RT) %>%
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
        taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure") %>%
  left_join(demo %>% select(sub.id, MDD_Status, Age.Bin, Age.Group, Age), 
            by = c("subID" = "sub.id")) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
nback.fmri.clean$taskCode <- as.numeric(as.character(nback.fmri.clean$taskCode))
nback.fmri.clean$ageCode <- as.numeric(as.character(nback.fmri.clean$ageCode))
nback.fmri.clean$groupCode <- as.numeric(as.character(nback.fmri.clean$groupCode))

#nback accuracy decreases as the task becomes harder, age negatively impacts nback accuracy too
nback.acc.fmri <- glmer(data = nback.fmri.clean, acc ~ taskCode + (1|subID), family = "binomial")
summary(nback.acc.fmri)
nback.acc.fmri.group <- glmer(data = nback.fmri.clean, acc ~ taskCode + ageCode + groupCode + (1|subID), family = "binomial")
summary(nback.acc.fmri.group)


#START HERE
#Accuracy
nback.fmri.acc <- summarySEwithin2(nback.fmri.clean, measurevar = "acc", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci, MDD_Status,Age.Group)) %>% arrange(level)
kable(nback.fmri.acc, digits = 3) %>% kable_styling()

p.nback.fmri.acc <- ggplot(nback.fmri.acc, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back fMRI Performance (Accuracy)") + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(MDD_Status ~ Age.Group)
nback.fmri.acc

#RT
m.nback.RT.fmri <- lmer(data = nback.fmri.clean, RT ~ taskCode + (1|subID))
summary(m.nback.RT.fmri)
m.nback.RT.fmri2 <- lmer(data = nback.fmri.clean, RT ~ taskCode + ageCode + groupCode + (1|subID))
summary(m.nback.RT.fmri2)

nback.fmri.RT <- summarySEwithin2(nback.fmri.clean, measurevar = "RT", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, MDD_Status,Age.Group)) %>% arrange(level)
kable(nback.fmri.RT, digits = 3) %>% kable_styling()

p.nback.fmri.RT <- ggplot(nback.fmri.RT, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back fMRI Performance (RT)")+ 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(MDD_Status ~ Age.Group)
p.nback.fmri.RT

nback.fmri.performance <- nback.fmri.clean %>% group_by(subID, level) %>%
  summarise(hitRate = (sum(hit)/16), FARate = sum(FA)/48, mRT = mean(RT)) %>%
  rename(task = "level")
```

## Cog-ED Choices

```{r WM_coged_fmri, warning=FALSE, message=FALSE}
wm.coged.fmri.clean <- WM.coged.fmri %>% filter(trial > 45) %>% filter(choice != 9) %>%
  select(-c(adjAmount, adjEff, taskAmount, ISI, valDuration, choiceDuration, maxRT)) %>%
  mutate(proxType = if_else(abs(proximityValue) == 1, "catch", "biased"),
         biasType = if_else(proximityValue >0, "low", "high"),
         trialType = if_else((proxType == "catch" & biasType == "high"), "high-catch",
                             (if_else((proxType == "catch" & biasType == "low"), "low-catch",
                             if_else((proxType == "biased" & biasType == "high"), "high-biased", "low-biased")))),
         choseHard = if_else((choice == 1), 0, 1),
         bias = if_else((biasType == "high" & choseHard == 1 | biasType == "low" & choseHard == 0), "pro", "anti"))%>%
  left_join(demo.sum %>% select(Participant.ID, MDD_Status, Age.Bin, Age.Group, Age), 
            by = c("subID" = "Participant.ID")) 

#The breakdown for those who have fmri coged data
fmri.age.sum <- wm.coged.fmri.clean %>%
  distinct(subID, .keep_all = TRUE) %>%
  group_by(Age.Group, MDD_Status) %>%
  summarise(total_count=n()) %>%
  as.data.frame()
fmri.age.sum

 wm.coged.fmri.hardChoice <- wm.coged.fmri.clean %>% select(subID, trialType, choseHard, MDD_Status,Age.Group) %>% group_by(subID, trialType, MDD_Status,Age.Group) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)
 
wm.coged.fmri.hardChoice.subj <- wm.coged.fmri.clean %>% select(subID, trialType, choseHard) %>% group_by(subID) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)

wm.coged.fmri.hardChoice.subj.sum <- wm.coged.fmri.hardChoice.subj %>%
  summarise(meanPropHard = mean(propHard), sdPropHard = sd(propHard))
 
wm.coged.prophard.sum <- summarySEwithin2(data = wm.coged.fmri.hardChoice, measurevar = "propHard", withinvars = c("trialType","MDD_Status","Age.Group"), idvar = "subID")
wm.coged.prophard.sum$trialType <- factor(wm.coged.prophard.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))

#plotting Cog-ED choices from scanner
p.wm.coged.hardChoice <- ggplot(wm.coged.prophard.sum, aes(x=trialType, y=propHard)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=propHard-ci, ymax=propHard+ci), width=.2, size=1.1) + 
    coord_cartesian(ylim=c(0,1.05)) +
  xlab("Trial Type") + ylab("Proportion Hard Choice") + ggtitle("WM Cog-ED Choice Behavior")+
  facet_grid(MDD_Status ~ Age.Group)
p.wm.coged.hardChoice

#summarizing RT from Cog-ED choices
wm.coged.fmri.RT.sum <- summarySEwithin2(data = wm.coged.fmri.clean, measurevar = "choiceRT", withinvars = c("trialType","bias","MDD_Status","Age.Group"), idvar = "subID")
wm.coged.fmri.RT.sum$trialType <- factor(wm.coged.fmri.RT.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))


#plotting Cog-ED choice RT from scanner
p.wm.coged.fmri.RT <- ggplot(wm.coged.fmri.RT.sum, aes(x=trialType, y=choiceRT, fill=bias)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=choiceRT-ci, ymax=choiceRT+ci), width=.2, size=1.1) +  
  xlab("Trial Type") + ylab("RT (seconds)") + ggtitle("WM Cog-ED Choice RT")+ 
  scale_fill_brewer(palette = "Paired:2",  name="Bias Type", labels=c("Anti","Pro"))+
  facet_grid(MDD_Status ~ Age.Group)
p.wm.coged.fmri.RT
```
