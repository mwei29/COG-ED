---
title: "Cog-ED MARCER Behavioral Results"
author: "Mengzhe Wei"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    toc: yes
    toc_float:
      collapsed: true
---
# MARCER COGED Behavioral Summary
#### There are 143 participants that have completed scan session. 142 participants have at least some coged/nback in lab data (7306 was excluded due to not completing any coged/nback in and out of the scanner despite having IAPS data). 134 participants have at least some COGED scan data.
#### N.b. all error bars in this summary are 95% CIs
Started by MW in 12/10/24 to analyze MARCER COGED full behavioral data. The last version was CogED_MARCER_Behavior_2023.Rmd made by MW, adapted from JC's COGED PETMR project, for MW's SSM & ADAA projects in 2023.

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls());
#Packages
library(boxr); library(lme4); library(knitr); library(kableExtra); library(correlation); library(RColorBrewer); library(tidyverse);library(boxr);library(readxl);library(psych); library(easystats); library(insight)
source("summarySEwithin2.R")
# box_auth(); 

in.path <- "C:/Users/Emotion/Documents/GIT-MW/COG-ED/Prep/SubjectSet/" 
out.path <-"C:/Users/Emotion/Documents/GIT-MW/COG-ED/Analysis and Knitr/COGED behavioral/" 
dir.desc <- "20250114";  
sub.tbl <- read.table(paste0(in.path, dir.desc, "_subjectSet.txt"), stringsAsFactors=FALSE); #Made from GIT/MARCER/weie/COGED/defineSubjectSet.R
sub.ids <- sub.tbl$sub.id[which(sub.tbl$COGED_CatchNonCatch == TRUE)]
length(sub.ids) # Number of participants included in coged fMRI analysis
sub.ids.lab <- c("3051", "3085", "3093", "3097", "3117", "3139", "3204", "3218", "3235", "3347", 
                 "3358", "3366", "3443", "3478", "3499", "3615", "3736", "3893", "3905", "3936", 
                 "3942", "4001", "4053", "4078", "4123", "4323", "4330", "4355", "4427", "4457", 
                 "4500", "4550", "4647", "4751", "4756", "4762", "4780", "4816", "4839", "4956", 
                 "4977", "5013", "5027", "5115", "5128", "5143", "5177", "5222", "5359", "3710",
                 "5402", "5433", "5436", "5501", "5614", "5663", "5773", "5827", "5889", "5920", 
                 "5929", "5999", "6143", "6146", "6219", "6333", "6343", "6422", "6452", "6508", 
                 "6524", "6529", "6558", "6597", "6609", "6820", "6978", "6995", "7124", "7233", 
                 "7299", "7307", "7384", "7449", "7504", "7570", "7616", "7668", "7723", "7739", 
                 "7750", "7807", "7823", "7875", "7902", "7939", "7979", "7993", "8000", "8170", 
                 "8189", "8271", "8305", "8395", "8578", "8585", "3008", "3105", "3147", "3200", 
                 "3287", "3355", "3384", "3406", "3867", "3868", "3958", "4020", "4308", "4314", 
                 "4694", "4846", "5148", "5264", "5588", "5728", "5948", "6457", "6579", "6756", 
                 "6822", "6946", "7088", "7552", "7685", "8016", "8130", "8556", "3217", 
                 "6931", "8150", "8402") #This comes from fMRI subject notes in MARCER Basecamp to include everyone who attempted the scan, regardless of whether they have scan data. Do note that 7306 doesn't have coged data due to compliance issue
length(sub.ids.lab)
# # Load demographic
# demo.tbl <- read_excel(paste0(in.path,"data_per_participant.xlsx"))
# #https://wustl.app.box.com/file/1566635094447?s=49s7ro9bu7jn4tkvjihc69ut3gikmqc4
# eth.tbl <- read_excel(paste0(in.path,"ethnicity.xlsx")) #based on MARCER master spreadsheet
# demo <- demo.tbl[demo.tbl$sub.id %in% sub.ids.lab,] # filter only participant who attempted scan
# demo$sub.id<-as.integer(demo$sub.id)
# eth.tbl$PID<-as.integer(eth.tbl$PID)
# demo <- demo %>%
#   left_join(eth.tbl %>% select(PID, Ethnicity), by = c("sub.id" = "PID"))
# write.csv(demo, "demo.csv", row.names = FALSE)
# # Run the following code if the data sets are not compiled yet #Quick note, follow up 6558 was entered wrong in the data set as 6885. I directly edited it in my compiled dataset instead of changing the raw data. 
# Load COGED and nback data from box, preprocessed folder
# tasks <- c("coged.lab","coged.fmri","NASA","nback.lab","nback.fmri")
# task.names <- c("coged-MARCER-","coged-MARCER-fMRI-","followupredcap-MARCER-","nback-MARCER-","scan-nback-MARCER-")
# for (tid in 1:length(tasks)) {
#   assign(tasks[tid], data.frame())
#   print(paste0("Processing task:", tasks[tid]))
#   if (tid %in% c(2, 5)){
#     sub <- sub.ids
#   } else {
#     sub <- sub.ids.lab
#   }
#   for (sid in 1:length(sub)) {
#     print(paste0("Processing sub.id:", sub[sid]))
#     fname <- paste0(task.names[tid],sub[sid], "-converted.csv")
#     fid <- box_search(fname)
#     if (is.null(fid)) {
#       print(paste("File not found for sub.id:", sub[sid], "in task:", tasks[tid]))
#       next
#     }
#     tmp.tbl <- box_read(fid) %>% as.data.frame() # Read in the file and store the data as a dataframe
#     if (tasks[tid] == "NASA") {
#       tmp.tbl <- tmp.tbl[,1:60]
#       tmp.tbl$hbc1 <- as.integer(tmp.tbl$hbc1)
#       tmp.tbl$hbc2 <- as.integer(tmp.tbl$hbc2)
#       tmp.tbl$confience2 <- as.integer(tmp.tbl$confience2)
#       tmp.tbl$s2pid <- as.integer (tmp.tbl$s2pid)
#     }
#     df <- get(tasks[tid]) # Retrieve the existing data frame
#     df <- bind_rows(df, tmp.tbl) # Append rows to the data frame
#     assign(tasks[tid], df) # Update the data frame in the environment
#   }
#     write.csv(get(tasks[tid]), paste0(tasks[tid], ".csv"), row.names = FALSE)
#   }
# # Flip proximity value because we are following JC's JNeuro paper
# coged.fmri$proximityValue<--coged.fmri$proximityValue
# write.csv(coged.fmri, paste0("coged.fmri.csv"), row.names = FALSE)
demo <- read.csv("demo.csv")
coged.lab<- read.csv("coged.lab.csv")
coged.fmri<- read.csv("coged.fmri.csv")
NASA <- read.csv("NASA.csv")
nback.lab <- read.csv("nback.lab.csv")
nback.fmri <- read.csv("nback.fmri.csv")
```

## Demographic 

### in-lab
```{r Demo, echo=F, warning=FALSE, message=FALSE,cache=TRUE}
#Age
demo %>%
  group_by(Age.Group) %>%
  summarise(total_count=n()) 
demo %>%
  group_by(Age.Bin) %>%
  summarise(total_count=n()) 
describe(demo$Age)
#Gender
demo %>% select(Gender) %>%
  count(Gender)
#MDD status
demo %>% select(MDD_Status) %>%
  count(MDD_Status)
demo %>% 
  group_by(Age.Group,MDD_Status) %>%
  summarise(total_count=n()) 
demo %>% 
  group_by(Age.Bin,MDD_Status) %>%
  summarise(total_count=n()) 
demo %>% 
  group_by(Age.Group,MDD_Status,Gender) %>%
  summarise(total_count=n()) 
#Race
demo %>% select(Race) %>%
  count(Race)
demo %>% 
  group_by(Age.Group,MDD_Status,Race) %>%
  summarise(total_count=n()) 
demo %>% select(Ethnicity) %>%
  count(Ethnicity)
```

### scan
```{r Demo_scan, echo=F, warning=FALSE, message=FALSE,cache=TRUE}
# BREAKDOWN of the scan data
demo.scan <- demo[demo$sub.id %in% sub.ids,]
#Age
demo.scan %>%
  group_by(Age.Group) %>%
  summarise(total_count=n()) 
demo.scan %>%
  group_by(Age.Bin) %>%
  summarise(total_count=n()) 
describe(demo.scan$Age)
#Gender
demo.scan %>% select(Gender) %>%
  count(Gender)
#MDD status
demo.scan %>% select(MDD_Status) %>%
  count(MDD_Status)
demo.scan %>% 
  group_by(Age.Group,MDD_Status) %>%
  summarise(total_count=n()) 
demo.scan %>% 
  group_by(Age.Bin,MDD_Status) %>%
  summarise(total_count=n()) 
demo.scan %>% 
  group_by(Age.Group,MDD_Status,Gender) %>%
  summarise(total_count=n()) 
#Race
demo.scan %>% select(Race) %>%
  count(Race)
demo.scan %>% 
  group_by(Age.Group,MDD_Status,Race) %>%
  summarise(total_count=n()) 
demo.scan %>% select(Ethnicity) %>%
  count(Ethnicity)
```

## Lab Session

### N-Back Performance
```{r nback, echo=F, warning=F, message=F,cache=TRUE}
#Summarizing n-back performance
nback.lab <- left_join(nback.lab, demo %>% 
                       select(sub.id, MDD_Status, Age.Group,Age), 
                       by = c("subID" = "sub.id")) %>% 
  select(subID, level, kind, acc, RT, MDD_Status, Age.Group,Age) %>% 
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
         taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         ageCode = factor (Age.Group, levels = c("MA", "OA"), labels = c(0,1)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure")
nback.lab$taskCode <- as.numeric(as.character(nback.lab$taskCode))
nback.lab$ageCode <- as.numeric(as.character(nback.lab$ageCode))
nback.lab$groupCode <- as.numeric(as.character(nback.lab$groupCode))

#Accuracy - without group; as expected, accuracy goes down as task becomes harder
nback.lab.acc <- glmer(data = nback.lab, acc ~ taskCode + (1 | subID), family = "binomial")
summary(nback.lab.acc)
nback.lab.acc.sum <- summarySEwithin2(nback.lab, measurevar = "acc", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci)) %>% arrange(level)
kable(nback.lab.acc.sum, digits = 3) %>% kable_styling()
#Visualization
p.nback.lab.acc <- ggplot(nback.lab.acc.sum, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") 
p.nback.lab.acc + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#Accuracy - with groups; as expected, age has a negative main effect on accuracy, MDD N.S.
nback.lab.acc.group <- glmer(data = nback.lab, acc ~ taskCode + ageCode + groupCode + (1 | subID), family = "binomial")
summary(nback.lab.acc.group)
nback.lab.acc.sum.group <- summarySEwithin2(nback.lab, measurevar = "acc", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
          rename("trial_type" = kind) %>% 
          select(c(level, trial_type, acc, sd, se, ci, MDD_Status, Age.Group)) %>%
          arrange(level)
p.nback.lab.acc.group <- ggplot(nback.lab.acc.sum.group, aes(x=level, y=acc, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back Performance (Accuracy)") +
  facet_grid(MDD_Status ~ Age.Group) + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.lab.acc.group

#RT; as expected, RT increases as nback gets harder
nback.lab.RT <- lmer(data = nback.lab, RT ~ taskCode + (1 | subID))
summary(nback.lab.RT)
nback.lab.RT.sum <- summarySEwithin2(nback.lab, measurevar = "RT", withinvars = c("level","kind"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci)) %>% arrange(level)
kable(nback.lab.RT.sum, digits = 3) %>% kable_styling()
#Visualization
p.nback.lab.RT <- ggplot(nback.lab.RT.sum, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)")
p.nback.lab.RT + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))

#RT - with group
nback.lab.RT.group <- lmer(data = nback.lab, RT ~ taskCode +  ageCode + groupCode + (1 | subID))
summary(nback.lab.RT.group)
nback.lab.RT.sum.group <- summarySEwithin2(nback.lab, measurevar = "RT", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, MDD_Status, Age.Group)) %>% arrange(level)
kable(nback.lab.RT.sum.group, digits = 3) %>% kable_styling()

p.nback.lab.RT.group <- ggplot(nback.lab.RT.sum.group, aes(x=level, y=RT, fill=trial_type, group=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back Performance (RT)") +
  facet_grid(MDD_Status ~ Age.Group) + scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))
p.nback.lab.RT.group
```


### COGED SV and RT
(Black = 1-back, Red = 2-Back, Blue = 3-back, Purple = 4-back)
We are not seeing an age or MDD effect in SV..
```{r SV_CogED, echo=T, warning=F, message=F,cache=TRUE}
#clean data frame with Cog-ED SV estimates
coged.lab <- left_join(coged.lab, demo %>%
                       select(sub.id, MDD_Status, Age.Group, Age),
                       by = c("subID" = "sub.id")) %>%
  group_by(subID) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         taskCode = factor(task, levels=c(1,2,3), labels=c(-1,0,1)),
         rewardCode = factor(amount, levels = c(2,3,4), labels = c(-1,0,1)),
         task = factor(task, levels=c(1,2,3), labels=c("Red","Blue","Purple")))

coged.lab$taskCode <- as.numeric(as.character(coged.lab$taskCode))
coged.lab$rewardCode <- as.numeric(as.character(coged.lab$rewardCode))
coged.lab$groupCode <- as.numeric(as.character(coged.lab$groupCode))
coged.lab$ageCode <- as.numeric(as.character(coged.lab$ageCode))
coged.lab$Age <- as.numeric(as.character(coged.lab$Age))

coged.SV <- coged.lab %>% group_by(subID, task, Age.Group, MDD_Status) %>%
summarise(meanSV = mean(SV))
coged.SV

#testing for differences across task & condition (red, blue, purple). As predicted, SV is discounted with task difficulty
SV <- lmer(data = coged.lab, SV ~ taskCode + (1 | subID))
summary(SV)

SV.group <- lmer(data = coged.lab, SV ~ taskCode + ageCode + groupCode + (1 | subID))
summary(SV.group)
```

### COGED SV plot
``` {r CogED_SV_Plot, echo=F, warning = F, message = F, cache=TRUE}
#summary of data for plotting
coged.lab.sum <- summarySEwithin2(coged.lab, measurevar = "SV", withinvars = c("task","MDD_Status","Age.Group"), idvar = "subID")
#Plotting
p.SV <- ggplot(coged.lab.sum, aes(x=task, y=SV, fill=task, color=task)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = coged.SV, aes(x=task, y=meanSV, color=task),
             stat="identity", alpha=0.7, position = "jitter") +
  coord_cartesian(ylim=c(0,1)) +
  scale_x_discrete(breaks=NULL) +
  xlab("") + ylab("Subjective Value") +
  facet_grid(MDD_Status ~ Age.Group) + 
  scale_fill_brewer(palette = "Set1",  name="Task Effort Level", labels=c("Low","Medium","High")) + scale_color_brewer(palette = "Set1", name="Task Effort Level", labels=c("Low","Medium","High"))
p.SV
#Plotting with participants' lines
p.SV.pt <- ggplot(coged.lab.sum, aes(x=task, y=SV)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = coged.SV, aes(x=task, y=meanSV),
             stat="identity", alpha=0.7) +
  geom_line(data = coged.SV, aes(x=task, y=meanSV, group=subID, colour = factor(subID)), alpha = .5) +
  coord_cartesian(ylim=c(0,1)) +
  xlab("Task") + ylab("Subjective Value") +
  facet_grid(MDD_Status ~ Age.Group)
p.SV.discounting <- p.SV.pt + guides(colour=FALSE)
p.SV.discounting

#summarizing average SV
average.SV <- coged.lab %>% select(subID, SV, MDD_Status, Age.Group) %>%
  group_by(MDD_Status,Age.Group) %>%
  summarise(SV_avg = mean(SV)) 
average.SV
```

## Self-Report Questionnaires
NASA TLX (administered after each run of the familiarization tasks)
``` {r NASA, echo=F, warning = F, message = F, cache=TRUE}
#cleaning up data structures from REDCap
NASA <- NASA %>%
  pivot_longer(cols = c("black_mdemand", "black_pdemand", "black_tdemand", "red_mdemand", "red_pdemand", "red_tdemand", "blue_mdemand", "blue_pdemand", "blue_tdemand","purple_mdemand", "purple_pdemand", "purple_tdemand"), names_to = "condition", values_to = "rating") %>%
  separate(col = condition, into=c("Task","Characteristic"), sep = "_") %>%
  pivot_wider(values_from = rating, names_from = Characteristic) %>%
  rename(mental_demand = mdemand, 
         phsyical_demand = pdemand, 
         temporal_demand = tdemand) %>%
  left_join(demo %>% select(sub.id, MDD_Status, Age.Group, Age), 
            by = c("participant_id" = "sub.id")) 

#Mental Demand Ratings
NASA.demand <- NASA %>% select(participant_id, Task, mental_demand, MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.m.demand = mean(mental_demand)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.demand$taskCode <- as.numeric(as.character(NASA.demand$taskCode))
NASA.demand$ageCode <- as.numeric(as.character(NASA.demand$ageCode))
NASA.demand$groupCode <- as.numeric(as.character(NASA.demand$groupCode))

#Multi-level model (implemented in lme4). As predicted, the more effortful the task is, the more mental demand pt endorses.
mentalDemand <- lmer(mean.m.demand ~ taskCode + (1 | participant_id), data = NASA.demand)
summary(mentalDemand)

mentalDemand.group <- lmer(mean.m.demand ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.demand)
summary(mentalDemand.group)

NASA_mdemand_sum <- summarySEwithin2(NASA.demand, measurevar = "mean.m.demand", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_mdemand_sum$Task <- factor(NASA_mdemand_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.demand <- ggplot(NASA_mdemand_sum, aes(x=Task, y=mean.m.demand)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.m.demand-ci, ymax=mean.m.demand+ci), width=.2) +  
  xlab("Task") + ylab("Mental Demand") + ggtitle("Self-Reported Mental Demand") +
  facet_grid(MDD_Status ~ Age.Group)
p.demand

#Effort Ratings
NASA.effort <- NASA %>% 
  mutate(effort = case_when(
    Task == "black" ~ black_effort,
    Task == "red" ~ red_effort,
    Task == "blue" ~ blue_effort,
    Task == "purple" ~ purple_effort
  )) %>%
  select(participant_id, Task, effort,MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.effort = mean(effort)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.effort$taskCode <- as.numeric(as.character(NASA.effort$taskCode))
NASA.effort$ageCode <- as.numeric(as.character(NASA.effort$ageCode))
NASA.effort$groupCode <- as.numeric(as.character(NASA.effort$groupCode))

#Multi-level model (implemented in lme4)
effort <- lmer(mean.effort ~ taskCode + (1 | participant_id), data = NASA.effort)
summary(effort)
effort.group <- lmer(mean.effort ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.effort)
summary(effort.group)

NASA_effort_sum <- summarySEwithin2(NASA.effort, measurevar = "mean.effort", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_effort_sum$Task <- factor(NASA_effort_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.effort <- ggplot(NASA_effort_sum, aes(x=Task, y=mean.effort)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.effort-ci, ymax=mean.effort+ci), width=.2) +  
  xlab("Task") + ylab("Effort") + ggtitle("Self-Reported Effort") +
  facet_grid(MDD_Status ~ Age.Group)
p.effort

#Frustration Ratings
NASA.frust <- NASA %>% 
  mutate(frustration = case_when(
    Task == "black" ~ black_frustration,
    Task == "red" ~ red_frustration,
    Task == "blue" ~ blue_frustration,
    Task == "purple" ~ purple_frustration
  )) %>%
  select(participant_id, Task, frustration,MDD_Status,Age.Group) %>%
  group_by(participant_id, Task,MDD_Status,Age.Group) %>%
  dplyr::summarise(mean.frust = mean(frustration)) %>%
  mutate(taskCode = factor(Task, levels = c("black", "red", "blue", "purple"), labels = c(0,1,2,3)),
         ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
NASA.frust$taskCode <- as.numeric(as.character(NASA.frust$taskCode))
NASA.frust$ageCode <- as.numeric(as.character(NASA.frust$ageCode))
NASA.frust$groupCode <- as.numeric(as.character(NASA.frust$groupCode))
  
#Multi-level model (implemented in lme4)
frust <- lmer(mean.frust ~ taskCode + (1 | participant_id), data = NASA.frust)
summary(frust)

frust.group <- lmer(mean.frust ~ taskCode + ageCode + groupCode + (1 | participant_id), data = NASA.frust)
summary(frust.group)

NASA_frust_sum <- summarySEwithin2(NASA.frust, measurevar = "mean.frust", withinvars = c("Task", "MDD_Status","Age.Group"), idvar = "participant_id")
NASA_frust_sum$Task <- factor(NASA_frust_sum$Task, levels = c("black", "red", "blue", "purple"), labels = c("black", "red", "blue", "purple"))

#plotting NASA ratings
p.frust <- ggplot(NASA_frust_sum, aes(x=Task, y=mean.frust)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=mean.frust-ci, ymax=mean.frust+ci), width=.2) +  
  xlab("Task") + ylab("Frustration") + ggtitle("Self-Reported Frustration")+
  facet_grid(MDD_Status ~ Age.Group)
p.frust
```

## fMRI Session

### N-Back Performance in scanner
```{r nback_fmri, echo=F, warning=F, message=F, cache=TRUE}
#summarizing n-back task performance in the scanner
nback.fmri.clean <- nback.fmri %>% filter(resp != 9) %>%select(subID, level, kind, acc, RT) %>%
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
        taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure") %>%
  left_join(demo %>% select(sub.id, MDD_Status, Age.Bin, Age.Group, Age), 
            by = c("subID" = "sub.id")) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)))
nback.fmri.clean$taskCode <- as.numeric(as.character(nback.fmri.clean$taskCode))
nback.fmri.clean$ageCode <- as.numeric(as.character(nback.fmri.clean$ageCode))
nback.fmri.clean$groupCode <- as.numeric(as.character(nback.fmri.clean$groupCode))
nback.fmri.clean$Age <- as.numeric(as.character(nback.fmri.clean$Age))

#nback accuracy decreases as the task becomes harder, age negatively impacts nback accuracy too
nback.fmri.acc <- glmer(data = nback.fmri.clean, acc ~ taskCode + (1|subID), family = "binomial")
summary(nback.fmri.acc)
nback.fmri.acc.group <- glmer(data = nback.fmri.clean, acc ~ taskCode + ageCode + groupCode + (1|subID), family = "binomial")
summary(nback.fmri.acc.group)

#Accuracy
nback.fmri.acc.sum <- summarySEwithin2(nback.fmri.clean, measurevar = "acc", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, acc, sd, se, ci, MDD_Status,Age.Group)) %>% arrange(level)
kable(nback.fmri.acc.sum, digits = 3) %>% kable_styling()

p.nback.fmri.acc <- ggplot(nback.fmri.acc.sum, aes(x=level, y=acc, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=acc-ci, ymax=acc+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("Accuracy") + ggtitle("N-Back fMRI Performance (Accuracy)") + 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(MDD_Status ~ Age.Group)
p.nback.fmri.acc

#RT; RT increases as task gets harder & age increases
nback.fmri.RT <- lmer(data = nback.fmri.clean, RT ~ taskCode + (1|subID))
summary(nback.fmri.RT)
nback.fmri.RT.group <- lmer(data = nback.fmri.clean, RT ~ taskCode + ageCode + groupCode + (1|subID))
summary(nback.fmri.RT.group)

nback.fmri.RT.sum <- summarySEwithin2(nback.fmri.clean, measurevar = "RT", withinvars = c("level","kind","MDD_Status","Age.Group"), idvar = "subID") %>%
          mutate(kind = factor(kind, levels = c(0,1), labels = c("non-target","target"))) %>%
  rename("trial_type" = kind) %>% select(c(level, trial_type, RT, sd, se, ci, MDD_Status,Age.Group)) %>% arrange(level)
kable(nback.fmri.RT.sum, digits = 3) %>% kable_styling()

p.nback.fmri.RT <- ggplot(nback.fmri.RT.sum, aes(x=level, y=RT, fill=trial_type)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=RT-ci, ymax=RT+ci), width=.2, size=1.1) +  
  xlab("N-Back Level") + ylab("RT (seconds)") + ggtitle("N-Back fMRI Performance (RT)")+ 
  scale_fill_brewer(palette = "Paired",  name="Trial Type", labels=c("Non-Target","Target"))+
  facet_grid(MDD_Status ~ Age.Group)
p.nback.fmri.RT

nback.fmri.performance <- nback.fmri.clean %>% group_by(subID, level) %>%
  summarise(hitRate = (sum(hit)/16), FARate = sum(FA)/48, mRT = mean(RT)) %>%
  rename(task = "level")
nback.fmri.performance
```

### Cog-ED Choices in scanner
```{r coged_fmri, echo=T, warning=FALSE, message=FALSE, cache=TRUE}
coged.fmri.clean <- coged.fmri %>% filter(trial > 45) %>% filter(choice != 9) %>%
  select(-c(adjAmount, adjEff, taskAmount, ISI, valDuration, choiceDuration, maxRT)) %>%
  mutate(proxType = if_else(abs(proximityValue) == 1, "catch", "biased"),
         biasType = if_else(proximityValue >0, "low", "high"),
         trialType = if_else((proxType == "catch" & biasType == "high"), "high-catch",
                             (if_else((proxType == "catch" & biasType == "low"), "low-catch",
                             if_else((proxType == "biased" & biasType == "high"), "high-biased", "low-biased")))),
         choseHard = if_else((choice == 1), 0, 1),
         loadCode = factor(hardTask, levels = c(1,2,3), labels = c(-1,0,1)),
         rewardCode = factor(rewardAmount, levels = c(2,3,4), labels = c(-1,0,1)),
         bias = if_else((biasType == "high" & choseHard == 1 | biasType == "low" & choseHard == 0), "pro", "anti"))%>%
  left_join(demo %>% select(sub.id, MDD_Status, Age.Group, Age), 
            by = c("subID" = "sub.id")) %>%
  mutate(ageCode = factor(Age.Group, levels = c("MA","OA"), labels = c(0,1)),
         groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         trialCode = factor (trialType, levels = c("low-catch","low-biased","high-biased","high-catch"),labels = c(0,1,2,3)))
coged.fmri.clean$loadCode <- as.numeric(as.character(coged.fmri.clean$loadCode))
coged.fmri.clean$rewardCode <- as.numeric(as.character(coged.fmri.clean$rewardCode))
coged.fmri.clean$trialCode <- as.numeric(as.character(coged.fmri.clean$trialCode))
coged.fmri.clean$groupCode <- as.numeric(as.character(coged.fmri.clean$groupCode))
coged.fmri.clean$ageCode <- as.numeric(as.character(coged.fmri.clean$ageCode))
coged.fmri.clean$Age <- as.numeric(as.character(coged.fmri.clean$Age))

coged.fmri.hardChoice <- coged.fmri.clean %>% select(subID, trialType, choseHard, MDD_Status,Age.Group) %>% 
  group_by(subID, trialType, MDD_Status,Age.Group) %>%
  summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
  mutate(propHard = n_hardChoice/n_choice)
 
coged.fmri.hardChoice.subj <- coged.fmri.clean %>% select(subID, trialType, choseHard) %>% group_by(subID) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)
# The general proportion of hard choice is 0.49.
coged.fmri.hardChoice.subj.sum <- coged.fmri.hardChoice.subj %>%
  summarise(meanPropHard = mean(propHard), sdPropHard = sd(propHard))
 
#Summary by group
coged.prophard.sum <- summarySEwithin2(data = coged.fmri.hardChoice, measurevar = "propHard", withinvars = c("trialType","MDD_Status","Age.Group"), idvar = "subID")
coged.prophard.sum$trialType <- factor(coged.prophard.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))
#Collapse across trial types
coged.prophard.sum2 <- summarySEwithin2(data = coged.fmri.hardChoice, measurevar = "propHard", withinvars = c("MDD_Status","Age.Group"), idvar = "subID")

#plotting Cog-ED choices from scanner
p.coged.hardChoice <- ggplot(coged.prophard.sum, aes(x=trialType, y=propHard)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=propHard-ci, ymax=propHard+ci), width=.2, size=1.1) + 
    coord_cartesian(ylim=c(0,1.05)) +
  xlab("Trial Type") + ylab("Proportion Hard Choice") + ggtitle("WM Cog-ED Choice Behavior")+
  facet_grid(MDD_Status ~ Age.Group)
p.coged.hardChoice

#plotting Cog-ED choices from scanner, collapse across trial type
p.coged.hardChoice.2 <- ggplot(coged.prophard.sum2, aes(x=Age.Group, y=propHard,fill=MDD_Status)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=propHard-ci, ymax=propHard+ci), width=.2, size=1.1) + 
    coord_cartesian(ylim=c(0,0.7)) +
  labs(title = "Proportion of Choosing 'Hard' by Group and Age",
       x = "Age Group", y = "Proportion of Hard Choices", fill = "Group") +
    theme_minimal() 
p.coged.hardChoice.2

#Predict choice based on trial type
coged.hardChoice.group <- glmer(data = coged.fmri.clean, choseHard ~ trialCode + ageCode + groupCode + (1|subID),
                               family = binomial(link = "logit"))
summary(coged.hardChoice.group)

#Predict choice based on proximity
#As expected, higher proximity bias people to choose the harder option
coged.fmri.clean.prox <- coged.fmri.clean %>%
  mutate(Run = if_else(trial < 82, 1, if_else(trial > 117, 3, 2)),
         Trial = if_else(Run == 1, trial-45, if_else(Run == 2, trial-81, (trial-117))))%>%
  select(subID, Trial, Run, choice, proximityValue, choseHard,loadCode, rewardCode, ageCode, groupCode, choiceRT,Age,MDD_Status) %>% as_tibble()
coged.fmri.clean.prox$subID <- as.factor(coged.fmri.clean.prox$subID)

prox.choice <- glmer(data = coged.fmri.clean.prox, choseHard ~ proximityValue + rewardCode + loadCode + (proximityValue|subID), family = "binomial")

prox.choice.plot <- get_datagrid(prox.choice, by = c("proximityValue","subID"), preserve_range = TRUE)
preds <- estimate_relation(prox.choice, include_random = T, data = prox.choice.plot)

prox.choice.plot.fixed <- get_datagrid(prox.choice, by = c("proximityValue"), preserve_range = TRUE)
fixed_pred <- estimate_relation(prox.choice, at = "proximityValue", data = prox.choice.plot.fixed)

fig1 <- ggplot(fixed_pred, aes(x=proximityValue, y=Predicted)) + 
  geom_ribbon(data = fixed_pred, aes(x = proximityValue, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = proximityValue, y = Predicted), linewidth = 2) +
  geom_line(data = preds, aes(x=proximityValue, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "Relative Subjective Value of High-Effort Option", y="Proabability of High-Effort Option")
fig.pt <- fig1 + guides(colour=FALSE) + geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")
fig.pt

#add in colors for different groups
demo.scan$sub.id <-  as.factor(demo.scan$sub.id)
preds.group <- preds %>%
  left_join(demo.scan %>% select(sub.id, MDD_Status, Age.Group), by = c("subID" = "sub.id")) %>%
  mutate(group =  factor(paste(Age.Group, MDD_Status, sep = "_")))
# Compute group-level predictions
preds.agg <- preds.group %>%
  group_by(proximityValue, group) %>%
  summarise(Predicted = mean(Predicted, na.rm = TRUE),
            CI_low = mean(CI_low, na.rm = TRUE),
            CI_high = mean(CI_high, na.rm = TRUE)) %>%
  ungroup()

# Generate a smoothed logistic curve for each group
fig.group <- ggplot(preds.agg, aes(x = proximityValue, y = Predicted, color = group)) + 
  geom_ribbon(aes(ymin = CI_low, ymax = CI_high, fill = group), alpha = 0.2) +  # Shaded confidence bands
  geom_line(linewidth = 1.5) +  # Logistic curve per group
  theme_classic() + 
  labs(x = "Relative Subjective Value of High-Effort Option", 
       y = "Probability of Choosing High-Effort Option") +
  scale_color_manual(values = c("OA_MDD" = "#E63946",  
                                "MA_MDD" = "#F4A261",  
                                "OA_HC"  = "#457B9D", 
                                "MA_HC"  = "#2A9D8F")) +
  scale_fill_manual(values = c("OA_MDD" = "#E63946",  
                               "MA_MDD" = "#F4A261",  
                               "OA_HC"  = "#457B9D", 
                               "MA_HC"  = "#2A9D8F")) +
  guides(colour = guide_legend(title = "MDD and Age Status"), 
         fill = guide_legend(title = "MDD and Age Status")) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(legend.position = "right") 

# Display plot
fig.group

#summarizing RT from Cog-ED choices
coged.fmri.RT.sum <- summarySEwithin2(data = coged.fmri.clean, measurevar = "choiceRT", withinvars = c("trialType","bias","MDD_Status","Age.Group"), idvar = "subID")
coged.fmri.RT.sum$trialType <- factor(coged.fmri.RT.sum$trialType, levels = c("high-catch", "high-biased", "low-biased", "low-catch"), 
                                             labels = c("high-catch", "high-biased", "low-biased", "low-catch"))


#plotting Cog-ED choice RT from scanner
p.coged.fmri.RT <- ggplot(coged.fmri.RT.sum, aes(x=trialType, y=choiceRT, fill=bias)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.1) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=choiceRT-ci, ymax=choiceRT+ci), width=.2, size=1.1) +  
  xlab("Trial Type") + ylab("RT (seconds)") + ggtitle("WM Cog-ED Choice RT")+ 
  scale_fill_brewer(palette = "Paired:2",  name="Bias Type", labels=c("Anti","Pro"))+
  facet_grid(MDD_Status ~ Age.Group)
p.coged.fmri.RT
```

# Hypotheses testing

## H1: Cognitive Effort Discounting (SV Encoding) 

Model: multilevel linear model with subjective value (SV) as the dependent variable and task load (N-back level) as the independent variable. 

**Predictors:** <br>
- Main effect of N-back level (H1a)  <br>
- Interaction between N-back level and age (H1b). <br>
- Interaction between N-back level and MDD status (MDD vs. HC; H1c).  <br>
- Covariate: N-back accuracy during familiarization phase
```{r H1, warning=F, message=F, cache=T}
nback.lab.acc <- summarySEwithin2(nback.lab, measurevar = "acc", withinvars = c("level","subID"), idvar = "subID") %>%
  select(c(subID,level, acc, sd, se, ci)) %>%
  arrange(subID) %>%
  mutate(subID=as.integer(as.character(subID)))
coged.lab.SV <- coged.lab %>%
  left_join(nback.lab.acc %>% select(subID, level, acc), 
            by = c("subID" = "subID", "task" = "level"))
#H1a
SV <- lmer(data = coged.lab.SV, SV ~ taskCode + Age + groupCode + acc + (1 | subID))
summary(SV)
#H1b
SV.age <- lmer(data = coged.lab.SV, SV ~ taskCode*Age + groupCode + acc + (1 | subID))
summary(SV.age)
ef <- effects::effect(term="taskCode*Age", xlevels= list(Age=c(42.29, 63.85)), mod=SV.age)
efdata<-as.data.frame(ef) #convert the effects list to a data frame
efdata$Age<-as.factor(efdata$Age)
ggplot(efdata, aes(x=taskCode, y=fit, color=Age,group=Age)) + 
    geom_point() + 
    geom_line(size=1.2) +
    geom_ribbon(aes(ymin=fit-se, ymax=fit+se, fill=Age),alpha=0.3) + 
    labs(x= "N-back Difficulty", y="Subjective Value", color="Age", fill="Age") +
    theme_classic() + theme(text=element_text(size=12)) + 
    scale_y_continuous(breaks = seq(0, 1, by=0.1), limits=c(0.3,0.8)) +
    scale_x_continuous(breaks = seq(-1, 1, by=0.5), limits=c(-1, 1))
#H1c
SV.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode*groupCode + Age + acc + (1 | subID))
summary(SV.MDD)
ef <- effects::effect(term="taskCode*groupCode", xlevels= list(groupCode = c(0,1)), mod=SV.MDD)
efdata<-as.data.frame(ef) #convert the effects list to a data frame
efdata$groupCode<-as.factor(efdata$groupCode)
ggplot(efdata, aes(x=taskCode, y=fit, color=groupCode,group=groupCode)) + 
    geom_point() + 
    geom_line(size=1.2) +
    geom_ribbon(aes(ymin=fit-se, ymax=fit+se, fill=groupCode),alpha=0.3) + 
    labs(x= "N-back Difficulty", y="Subjective Value", color="groupCode", fill="groupCode") +
    theme_classic() + theme(text=element_text(size=12)) + 
    scale_y_continuous(breaks = seq(0, 1, by=0.1), limits=c(0.3,0.8)) +
    scale_x_continuous(breaks = seq(-1, 1, by=0.5), limits=c(-1, 1))

#Exploratory: age & MDD interaction. 
SV.age.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode*Age*groupCode + acc + (1 | subID))
summary(SV.age.MDD)

age_mean <- mean(coged.lab.SV$Age, na.rm = TRUE)
age_sd <- sd(coged.lab.SV$Age, na.rm = TRUE)

# Generate the effect using Age at ±1 SD
ef <- effects::effect("taskCode*Age*groupCode", 
             mod = SV.age.MDD, 
             xlevels = list(Age = c(age_mean - age_sd, age_mean, age_mean + age_sd), groupCode =c(0,1) ))

# Convert to dataframe
efdata <- as.data.frame(ef)
efdata$groupCode <- as.factor(efdata$groupCode)

# Convert Age values into factor labels
efdata$Age <- factor(efdata$Age, 
                     levels = c(age_mean - age_sd, age_mean, age_mean + age_sd), 
                     labels = c("Low Age (-1 SD)", "Mean Age", "High Age (+1 SD)"))

# Plot the three-way interaction
ggplot(efdata, aes(x = taskCode, y = fit, color = groupCode, group = groupCode)) + 
    geom_line(size = 1.2) +
    geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = groupCode), alpha = 0.3) + 
    labs(x = "N-back Difficulty", y = "Subjective Value", 
         color = "groupCode", fill = "groupCode") +
    theme_classic() +
    facet_wrap(~ Age)

#SV in relationship to both taskload and reward load
SV.rew <- lmer(data = coged.lab.SV, SV ~ taskCode + rewardCode + Age + groupCode + acc + (1 | subID))
summary(SV.rew)
```

A linear mixed-effects model examined the effects of **N-back level**, **age (cont.)**, and **MDD status (HC:0, MDD:1)** on **SV**, with **N-back Accuracy** being covariate.

### H1a: Main Effect
- **N-back level significantly predicted SV** (*β* = **-0.1059**, *t* = **-11.79**, *p* < .001), confirming the **cognitive effort discounting effect**, where **higher N-back levels led to lower subjective value**.
- **Accuracy (acc) was a significant positive predictor of SV** (*β* = **0.3315**, *t* = **3.43**, *p* < .001), suggesting that **higher task accuracy was associated with higher subjective value**.
- **Age** (*β* = **-0.00002**, *t* = **-0.009**, *n.s.**) and **MDD status** (*β* = **0.0066**, *t* = **0.138**, *n.s.**) are **non-significant predictors of SV**.

### H1b & H1c: Two-Way Interactions
1. **N-back level × Age Interaction (H1b)**
   - The **task difficulty × age** interaction was **marginally significant** (*β* = **0.00134**, *t* = **1.88**, *p* = .06).
   - the trend suggests that as **age increases, the negative effect of N-back level on SV diminishes**.

2. **N-back level × MDD Interaction (H1c)**
   - In the two-way model, the interaction is marginal (*β* = **0.0277**, *t* = **1.80**, *p* = .07), suggesting that **MDD individuals may discount effort less steeply than controls**, though this effect is weaker when accounting for accuracy.

### Exploratory Analysis: Three-Way Interaction 
A **three-way interaction (N-back level × Age × MDD status) was significant** (*β* = **0.0044**, *t* = **3.06**, *p* < .01), meaning that **the relationship between MDD and task difficulty depends on age**.

- In **younger adults**, MDD individuals **discounted effort more steeply** than controls.
- In **older adults**, the difference between MDD and controls **diminished**.

## H2: Proximity Effect on Choice Behavior

Model: Logistic regression predicting choice of the higher-effort option as a function of proximity. 

**Predictors:** <br>
- Main effect of proximity (H2a). <br>
- Interaction between proximity and age (H2b). <br>
- Interaction between proximity and MDD status (H2c). <br>
```{r H2, warning=F, message=F, cache=TRUE}
#H2a: as hypothesized: As proximity increases, people are biased to choose the harder option.
prox.choice <- glmer(data = coged.fmri.clean.prox, choseHard ~ proximityValue + Age + groupCode + (proximityValue|subID), family = "binomial")
summary(prox.choice)

prox.choice.plot <- get_datagrid(prox.choice, by = c("proximityValue","subID"), preserve_range = TRUE)
preds <- estimate_relation(prox.choice, include_random = T, data = prox.choice.plot)

prox.choice.plot.fixed <- get_datagrid(prox.choice, by = c("proximityValue"), preserve_range = TRUE)
fixed_pred <- estimate_relation(prox.choice, at = "proximityValue", data = prox.choice.plot.fixed)
fig1 <- ggplot(fixed_pred, aes(x=proximityValue, y=Predicted)) + 
  geom_ribbon(data = fixed_pred, aes(x = proximityValue, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = proximityValue, y = Predicted), linewidth = 2) +
  geom_line(data = preds, aes(x=proximityValue, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "Relative Subjective Value of High-Effort Option", y="Proabability of High-Effort Option")
fig.pt <- fig1 + guides(colour=FALSE) + geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")
fig.pt

preds.group <- preds %>%
  left_join(demo.scan %>% select(sub.id, MDD_Status, Age.Group), by = c("subID" = "sub.id")) %>%
  mutate(group =  factor(paste(Age.Group, MDD_Status, sep = "_")))
# Compute group-level predictions
preds.agg <- preds.group %>%
  group_by(proximityValue, group) %>%
  summarise(Predicted = mean(Predicted, na.rm = TRUE),
            CI_low = mean(CI_low, na.rm = TRUE),
            CI_high = mean(CI_high, na.rm = TRUE)) %>%
  ungroup()

# Generate a smoothed logistic curve for each group
fig.group <- ggplot(preds.agg, aes(x = proximityValue, y = Predicted, color = group)) + 
  geom_ribbon(aes(ymin = CI_low, ymax = CI_high, fill = group), alpha = 0.2) +  # Shaded confidence bands
  geom_line(linewidth = 1.5) +  # Logistic curve per group
  theme_classic() + 
  labs(x = "Relative Subjective Value of High-Effort Option", 
       y = "Probability of Choosing High-Effort Option") +
  scale_color_manual(values = c("OA_MDD" = "#E63946",  
                                "MA_MDD" = "#F4A261",  
                                "OA_HC"  = "#457B9D", 
                                "MA_HC"  = "#2A9D8F")) +
  scale_fill_manual(values = c("OA_MDD" = "#E63946",  
                               "MA_MDD" = "#F4A261",  
                               "OA_HC"  = "#457B9D", 
                               "MA_HC"  = "#2A9D8F")) +
  guides(colour = guide_legend(title = "MDD and Age Status"), 
         fill = guide_legend(title = "MDD and Age Status")) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(legend.position = "right") 

# Display plot
fig.group

#H2b: Older participants are less influenced by proximityValue when making their choice (p = .0009).
prox.choice.age <- glmer(data = coged.fmri.clean.prox, choseHard ~ proximityValue*Age + groupCode + (proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age)

#H2c: MDD interaction N.S.
prox.choice.MDD <- glmer(data = coged.fmri.clean.prox, choseHard ~ proximityValue*groupCode + Age + (proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.MDD)

#Exploratory: age & MDD interaction. The original model has a lot of convergence issue, so I centered the age variable. No significant interaction.
coged.fmri.clean.prox <- coged.fmri.clean.prox %>%
  mutate(Age_centered = scale(Age, center = TRUE, scale = FALSE))
prox.choice.age.MDD <- glmer(data = coged.fmri.clean.prox, choseHard ~ proximityValue*Age_centered*groupCode + (proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age.MDD)
```

A **generalized linear mixed-effects model** (GLMM) with a **binomial logit link** was used to examine the effects of **proximity value**, **age**, and **MDD status (MDD vs. HC)** on the likelihood of choosing the harder option.

### H2a: Main Effect of Proximity Value
- **Proximity value significantly predicted the likelihood of choosing the harder option** (Estimate = **2.99**, z = **15.947**, p < .001), suggesting that **as proximity value increases, participants are more likely to choose the harder option**.

- **Age (Estimate = -0.002, z = -0.117, n.s.)** and **MDD status (Estimate = -0.034, z = -0.084, n.s.)** were **not significant predictors** of choosing the harder option.

### H2b & H2c: Two-Way Interactions
1. **Proximity Value × Age Interaction (H1b)**
   - The interaction between **proximity value and age** was **significant** (Estimate = **-0.0543**, z = **-3.310**, p = **.0009**).
   - This suggests that as **age increases, the effect of proximity value on choosing the harder option decreases**, indicating that **older adults may be less influenced by proximity value when making effort-based decisions**.

2. **Proximity Value × MDD Interaction (H2c)**
   - The interaction between **proximity value and MDD status** was **not significant** (Estimate = **-0.4819**, z = **-1.308**, p = .191).
   - This suggests that **MDD status does not significantly moderate the effect of proximity value on choosing the harder option**.

### Exploratory Analysis: Three-Way Interaction 
A model including a **three-way interaction (Proximity Value × Age × MDD Status)** was tested to investigate whether the **influence of MDD on effort-based decisions varies by age**.

- **The three-way interaction was not significant** (Estimate = **-0.025**, z = **-0.781**, p = .435), indicating that **the relationship between proximity value, age, and MDD does not significantly impact choice behavior**.

## H3: Decision Difficulty proximity² on RT 

Model: Linear mixed-effects model predicting reaction time (RT) with proximity² as the independent variable. 

**Predictors:** <br>
- Main effect of proximity² (H2a). <br>
- Interaction between proximity² and age (H3b).  <br>
- Interaction between proximity² and MDD status (H2c). <br>
```{r H3, warning=F, message=F, cache=TRUE}
#H3a: proximity² did not significantly predict RT
prox.RT <- lmer(data = coged.fmri.clean.prox, choiceRT ~ I(proximityValue^2) + Age + groupCode + (I(proximityValue^2)|subID))
summary(prox.RT)

#H2b: In older adults, the negative effect of proximity² on RT is weaker.
prox.RT.age <- lmer(data = coged.fmri.clean.prox, choiceRT ~ I(proximityValue^2)*Age + groupCode + (I(proximityValue^2)|subID))
summary(prox.RT.age)

#H2c: MDD interaction N.S.
prox.RT.MDD <- lmer(data = coged.fmri.clean.prox, choiceRT ~ I(proximityValue^2)*groupCode + Age + (I(proximityValue^2)|subID))
summary(prox.RT.MDD)

#Exploratory: age & MDD interaction. N.S.
prox.RT.age.MDD <- lmer(data = coged.fmri.clean.prox, choseHard ~ I(proximityValue^2)*Age*groupCode + (I(proximityValue^2)|subID))
summary(prox.RT.age.MDD)
```

A **linear mixed-effects model (LMM)** was fit using **REML estimation** to examine the effects of **proximity²**, **age**, and **MDD status (groupCode: MDD vs. HC)** on **reaction time (RT)**.

### H3a: Main Effect of Proximity²
- **In the model without interactions, proximity² did not significantly predict RT** (Estimate = **-0.0418**, t = **-1.102**).
- However, **when age was included as an interaction term, proximity² became a significant predictor** (Estimate = **-0.6280**, t = **-3.448**).
- This suggests that **as proximity² increases, RT decreases**

### H3b: Proximity² × Age Interaction
- The **interaction between proximity² and age was significant** (Estimate = **0.0111**, t = **3.284**).
- This suggests that **the negative effect of proximity² on RT is weaker for older adults**.
- **Older adults may be less sensitive to proximity-related decision biases, taking more time even when proximity is high.**

### H3c: Proximity² × MDD Interaction
- The **interaction between proximity² and MDD status was non-significant** (Estimate = **0.0399**, t = **0.524**).
- This suggests that **MDD status does not meaningfully moderate the effect of proximity² on RT**, meaning **individuals with and without MDD show similar reaction time patterns in response to proximity.**

### Exploratory Three-Way Interaction: Proximity² × Age × MDD Status
- A **three-way interaction between proximity², age, and MDD status was not significant** (Estimate = **-0.0003**, t = **-0.096**).
- This suggests that **the interaction between proximity² and age does not differ between MDD and HC groups**, meaning that **age-related differences in proximity-based RT effects are similar across clinical and healthy populations.**


### Random Effects
- **Significant variability was observed across participants (subID)**.
- **The random slope of proximity² was negatively correlated with the intercept (-0.55 to -0.82 across models)**, suggesting that **individuals with higher baseline RT show weaker proximity² effects.**
