---
title: "Cog-ED MARCER Behavioral Results"
author: "Mengzhe Wei"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    toc: yes
    toc_float:
      collapsed: true
---
# MARCER COGED Behavioral Results
#### Note 092225, we are collapsing N-back performance across sessions. The final sample included 134 participants. 
#### N.b. all error bars in this summary are 95% CIs

```{r setup, echo=FALSE, warning=FALSE, message=FALSE, cache=F}
rm(list=ls());
#Packages
library(lme4); library(lmerTest); library(kableExtra); library(RColorBrewer); library(tidyverse); library(psych); library(easystats);library(yarrr)
source("C:/Users/11091/OneDrive - University of Southern California/Research/COGED/Data_Code/Tools/summarySEwithin2.R")

in.path <- "C:/Users/11091/OneDrive - University of Southern California/Research/COGED/Data_Code/Data/" 
dir.desc <- "20250114";  
sub.tbl <- read.table(paste0(in.path, "SubjectSet/", dir.desc, "_subjectSet.txt"), stringsAsFactors=FALSE); #Made from GIT/MARCER/weie/COGED/defineSubjectSet.R
sub.ids <- sub.tbl$sub.id[which(sub.tbl$COGED_CatchNonCatch == TRUE)]
length(sub.ids) # Number of participants included in coged fMRI analysis

demo <- read.csv(paste0(in.path, "BehaviorData/demo.csv"))
coged.lab<- read.csv(paste0(in.path, "BehaviorData/coged.lab.csv"))
coged.fmri<- read.csv(paste0(in.path, "BehaviorData/coged.fmri.csv"))
NASA <- read.csv(paste0(in.path, "BehaviorData/NASA.csv"))
nback.lab <- read.csv(paste0(in.path, "BehaviorData/nback.lab.csv"))
nback.fmri <- read.csv(paste0(in.path, "BehaviorData/nback.fmri.csv"))

demo <- demo %>%
  mutate(groupCode = factor (MDD_Status, levels = c("HC", "MDD"), labels = c(0,1)),
         ageCode = factor (Age.Group, levels = c("MA", "OA"), labels = c(0,1)),
         Age_centered = scale(Age, center = TRUE, scale = TRUE))
demo$ageCode <- as.numeric(as.character(demo$ageCode))
demo$groupCode <- as.numeric(as.character(demo$groupCode))
demo$Age_centered <- as.numeric(as.character(demo$Age_centered))

demo <- demo[demo$sub.id %in% sub.ids,]
coged.lab <- coged.lab[coged.lab$subID %in% sub.ids,]
coged.fmri <- coged.fmri[coged.fmri$subID %in% sub.ids,]
NASA <- NASA[NASA$s2pid %in% sub.ids,]
nback.lab <- nback.lab[nback.lab$subID %in% sub.ids,]
nback.fmri <- nback.fmri[nback.fmri$subID %in% sub.ids,]
```

## Demographic 
```{r Demo, echo=F, warning=FALSE, message=FALSE,cache=T}
#Age
demo %>%
  group_by(Age.Bin) %>%
  summarise(
    total_count = n(),
    perc = 100 * n() / nrow(demo)
  )
describe(demo$Age)
#Gender
demo %>% select(Gender) %>%
  count(Gender)%>%
  mutate(perc = 100 * n / sum(n))
#MDD status
demo %>% select(MDD_Status) %>%
  count(MDD_Status)%>%
  mutate(perc = 100 * n / sum(n))
demo %>% 
  group_by(Age.Bin,MDD_Status) %>%
  summarise(total_count = n()) %>%
  ungroup() %>%
  mutate(perc = 100 * total_count / sum(total_count)) 
demo %>% 
  group_by(Age.Bin,MDD_Status, Gender) %>%
  summarise(total_count = n()) %>%
  ungroup() %>%
  mutate(perc = 100 * total_count / sum(total_count))  
#Race
demo %>% select(Race) %>%
  count(Race)%>%
  mutate(perc = 100 * n / sum(n))
demo %>% 
  group_by(Age.Bin,MDD_Status,Race) %>%
  summarise(total_count = n()) %>%
  ungroup() %>%
  mutate(perc = 100 * total_count / sum(total_count))
demo %>% select(Ethnicity) %>%
  count(Ethnicity)%>%
  mutate(perc = 100 * n / sum(n))
```

## Dataset prepping

### N-Back: collapsing two N-Back session & cleaning dataset
```{r nback, echo=T, warning=F, message=F,cache=T}
nback.lab  <- nback.lab  %>% mutate(session = "lab")
nback.fmri <- nback.fmri %>% mutate(session = "fmri") #add in session
nback.all <- bind_rows(nback.lab, nback.fmri) #combine nback together

nback.all.clean <- left_join(nback.all, demo %>% 
                       select(sub.id, ageCode, Age_centered, Age.Group, groupCode, MDD_Status), 
                       by = c("subID" = "sub.id")) %>% 
  filter(resp != 9) %>%
  select(subID, level, kind, acc, RT, session, ageCode, Age_centered, Age.Group, groupCode, MDD_Status) %>% 
  mutate(level = factor(level, levels = c(1,2,3,4), labels = c("Black","Red","Blue","Purple")),
         taskCode = factor(level, levels =  c("Black","Red","Blue","Purple"), labels = c(0,1,2,3)),
         sessionCode = factor (session, levels = c("lab", "fmri"), labels = c(0,1)),
         type = factor(kind, levels = c(-1,0,1), labels = c("lure","non-target","target")),
         hit = if_else((kind == 1 & acc == 1), 1, 0),
         FA = if_else((kind == 0 & acc == 0), 1, 0)) %>%
  filter(type != "lure")
nback.all.clean$taskCode <- as.numeric(as.character(nback.all.clean$taskCode))
nback.all.clean$sessionCode <- as.numeric(as.character(nback.all.clean$sessionCode))
nback.all.clean$subID <- as.factor(nback.all.clean$subID)

nback.acc.sum <- summarySEwithin2(nback.all.clean, measurevar = "acc", withinvars = c("subID","level"), idvar = "subID")
nback.acc.sum$subID <- as.numeric(as.character(nback.acc.sum$subID))
```

### COGED: COGED SV, RT, and Choice
(Black = 1-back, Red = 2-Back, Blue = 3-back, Purple = 4-back)
```{r SV_CogED, echo=T, warning=F, message=F,cache=F}
#clean data frame with Cog-ED SV estimates
coged.lab <- left_join(coged.lab, demo %>%
                       select(sub.id, MDD_Status, Age.Group, Age_centered,groupCode),
                       by = c("subID" = "sub.id")) %>%
  group_by(subID) %>%
  mutate(taskCode = factor(task, levels=c(1,2,3), labels=c(-1,0,1)),
         rewardCode = factor(amount, levels = c(2,3,4), labels = c(-1,0,1)),
         task = factor(task, levels=c(1,2,3), labels=c("Red","Blue","Purple")))%>%
  ungroup()

coged.lab$taskCode <- as.numeric(as.character(coged.lab$taskCode))
coged.lab$rewardCode <- as.numeric(as.character(coged.lab$rewardCode))

coged.fmri <- coged.fmri %>% filter(trial > 45) %>% filter(choice != 9) %>%
  select(-c(adjAmount, adjEff, taskAmount, ISI, valDuration, choiceDuration, maxRT)) %>%
  mutate(proxType = if_else(abs(proximityValue) == 1, "catch", "biased"),
         biasType = if_else(proximityValue >0, "low", "high"),
         trialType = if_else((proxType == "catch" & biasType == "high"), "high-catch",
                             (if_else((proxType == "catch" & biasType == "low"), "low-catch",
                             if_else((proxType == "biased" & biasType == "high"), "high-biased", "low-biased")))),
         choseHard = if_else((choice == 1), 0, 1),
         loadCode = factor(hardTask, levels = c(1,2,3), labels = c(-1,0,1)),
         rewardCode = factor(rewardAmount, levels = c(2,3,4), labels = c(-1,0,1)),
         bias = if_else((biasType == "high" & choseHard == 1 | biasType == "low" & choseHard == 0), "pro", "anti"))

coged.fmri <- left_join(coged.fmri, demo %>% select(sub.id, MDD_Status, Age.Group, Age_centered, groupCode), 
            by = c("subID" = "sub.id")) %>%
  mutate(trialCode = factor (trialType, levels = c("low-catch","low-biased","high-biased","high-catch"),labels = c(0,1,2,3)))

coged.fmri$loadCode <- as.numeric(as.character(coged.fmri$loadCode))
coged.fmri$rewardCode <- as.numeric(as.character(coged.fmri$rewardCode))
coged.fmri$trialCode <- as.numeric(as.character(coged.fmri$trialCode))

coged.SV <- coged.lab %>% group_by(subID, task, Age.Group, MDD_Status) %>%
  summarise(meanSV = mean(SV))

coged.lab.SV <- coged.lab %>%
  left_join(nback.acc.sum %>% select(subID, level, acc),
            by = c("subID" = "subID", "task" = "level"))
coged.lab.SV$subID <- as.factor(coged.lab.SV$subID)

coged.fmri.prox <- coged.fmri %>%
  mutate(Run = if_else(trial < 82, 1, if_else(trial > 117, 3, 2)),
         Trial = if_else(Run == 1, trial-45, if_else(Run == 2, trial-81, (trial-117))))%>%
  select(subID, Trial, Run, choice, proximityValue, choseHard,loadCode, rewardCode, Age_centered, groupCode, choiceRT,MDD_Status) %>% as_tibble()
coged.fmri.prox$subID <- as.factor(coged.fmri.prox$subID)
```


## Confirmatory Analyses: Nback

### Nback Accuracy, collapsed across sessions
```{r nbackAcc, echo=T, warning=F, message=F,cache=T}
#Accuracy main effect model
nback.all.acc.group <- glmer(data = nback.all.clean, acc ~ taskCode + Age_centered + groupCode + sessionCode + (1 + taskCode | subID), family = "binomial")
summary(nback.all.acc.group)
#Accuracy age interaction model
nback.all.acc.group1 <- glmer(data = nback.all.clean, acc ~ taskCode*Age_centered + groupCode + sessionCode + (1 + taskCode | subID), family = "binomial")
summary(nback.all.acc.group1)
#Accuracy MDD interaction model
nback.all.acc.group2 <- glmer(data = nback.all.clean, acc ~ taskCode*groupCode + Age_centered + sessionCode + (1 + taskCode | subID), family = "binomial")
summary(nback.all.acc.group2)
#Accuracy Full three-way interaction model
nback.all.acc.group3 <- glmer(data = nback.all.clean, acc ~ taskCode*groupCode*Age_centered + sessionCode + (1 + taskCode | subID), family = "binomial", control = glmerControl(optimizer = "bobyqa"))
summary(nback.all.acc.group3)

#Panel A: All participant, spaghetti plot
nback.acc.plot <- get_datagrid(nback.all.acc.group, by = c("taskCode","subID"), preserve_range = TRUE)
preds <- estimate_relation(nback.all.acc.group, include_random = T, data = nback.acc.plot)

nback.acc.plot.fixed <- get_datagrid(nback.all.acc.group, by = c("taskCode"), preserve_range = TRUE)
fixed_pred <- estimate_relation(nback.all.acc.group, at = "taskCode", data = nback.acc.plot.fixed)
fig2A <- ggplot(fixed_pred, aes(x=taskCode, y=Predicted)) + 
  geom_line(data = preds, aes(x=taskCode, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "N-back Task Load", y="Accuracy") +
  geom_ribbon(data = fixed_pred, aes(x = taskCode, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = taskCode, y = Predicted), linewidth = 1.5) +
  scale_x_continuous(breaks = 0:3, labels = 1:4) +
  guides(colour=FALSE) 
fig2A

#Panel B-C: Group & Age
age_lvls <- c("Low Age (-1 SD)", "Mean Age", "High Age (+1 SD)")
cols3 <- setNames(piratepal("pony")[c(1,5,8)], age_lvls)
ef <- effects::effect("taskCode*groupCode*Age_centered", 
             mod = nback.all.acc.group3, 
             xlevels = list(Age_centered = c(-1, 0, 1), groupCode =c(0,1) ))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig2BC <- ggplot(efdata, aes(x = taskCode, y = fit, color = Age_centered)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) +
  facet_wrap(~ groupCode) +
  scale_x_continuous(breaks = 0:3, labels = 1:4) +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "N-back Task Load", y = "Accuracy", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines"))
fig2BC

##### Follow up: age effect in MDD-only & HC-only
nback.all.clean.HConly <- nback.all.clean %>% 
  filter(MDD_Status == "HC")
nback.all.clean.MDDonly <- nback.all.clean %>% 
  filter(MDD_Status == "MDD")

nback.all.acc.HConly <- glmer(data = nback.all.clean.HConly, acc ~ taskCode*Age_centered + sessionCode + (1 + taskCode | subID), family = "binomial")
summary(nback.all.acc.HConly)
nback.all.acc.MDDonly <- glmer(data = nback.all.clean.MDDonly, acc ~ taskCode*Age_centered + sessionCode + (1 + taskCode | subID), family = "binomial")
summary(nback.all.acc.MDDonly)
```

### Nback RT, collapsed across sessions
```{r nbackRT, echo=T, warning=F, message=F,cache=T}
#RT main effect model
nback.all.RT.group <- lmer(data = nback.all.clean, RT ~ taskCode +  Age_centered + groupCode + sessionCode + (1 + taskCode | subID))
summary(nback.all.RT.group)
#RT age interaction model
nback.all.RT.group1 <- lmer(data = nback.all.clean, RT ~ taskCode*Age_centered + groupCode + sessionCode + (1 + taskCode | subID))
summary(nback.all.RT.group1)
#RT group interaction model
nback.all.RT.group2 <- lmer(data = nback.all.clean, RT ~ taskCode*groupCode +  Age_centered + sessionCode + (1 + taskCode | subID))
summary(nback.all.RT.group2)
#RT Full three-way interaction model
nback.all.RT.group3 <- lmer(data = nback.all.clean, RT ~ taskCode*Age_centered*groupCode + sessionCode + (1 + taskCode | subID))
summary(nback.all.RT.group3)

#Panel A: All participant, spaghetti plot
nback.RT.plot <- get_datagrid(nback.all.RT.group, by = c("taskCode","subID"), preserve_range = TRUE)
preds <- estimate_relation(nback.all.RT.group, include_random = T, data = nback.RT.plot)

nback.RT.plot.fixed <- get_datagrid(nback.all.RT.group, by = c("taskCode"), preserve_range = TRUE)
fixed_pred <- estimate_relation(nback.all.RT.group, at = "taskCode", data = nback.RT.plot.fixed)
fig3A <- ggplot(fixed_pred, aes(x=taskCode, y=Predicted)) + 
  geom_line(data = preds, aes(x=taskCode, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "N-back Task Load", y="Reaction Time (s)") +
  geom_ribbon(data = fixed_pred, aes(x = taskCode, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = taskCode, y = Predicted), linewidth = 1.5) +
  scale_x_continuous(breaks = 0:3, labels = 1:4) +
  guides(colour=FALSE) 
fig3A

#Panel B & C
ef <- effects::effect("taskCode*Age_centered*groupCode", 
             mod = nback.all.RT.group3, 
             xlevels = list(Age_centered = c(-1, 0, 1), groupCode =c(0,1) ))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig3BC <- ggplot(efdata, aes(x = taskCode, y = fit, color = Age_centered, group = Age_centered)) + 
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) + 
  facet_wrap(~ groupCode) +
  scale_x_continuous(breaks = 0:3, labels = 1:4) +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "N-back Task Load", y = "Reaction Time (s)", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines"))
fig3BC

# Follow up: age effect in MDD-only & HC-only
nback.all.RT.HConly <- lmer(data = nback.all.clean.HConly, RT ~ taskCode*Age_centered + sessionCode + (1 + taskCode | subID), control = lmerControl(optimizer = "bobyqa"))
summary(nback.all.RT.HConly)
nback.all.RT.MDDonly <- lmer(data = nback.all.clean.MDDonly, RT ~ taskCode*Age_centered + sessionCode + (1 + taskCode | subID))
summary(nback.all.RT.MDDonly)
```

### COGED: SV
``` {r CogED_SV_Plot, eval=T, echo=F, warning = F, message = F, cache=T}
#summary of data for plotting
coged.lab.sum <- summarySEwithin2(coged.lab, measurevar = "SV", withinvars = c("task","MDD_Status","Age.Group"), idvar = "subID")
#Plotting with participants' lines
p.SV.pt <- ggplot(coged.lab.sum, aes(x=task, y=SV)) + 
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.y = element_text(face="bold", size=16),legend.title = element_text(face="bold", size=16)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.45, size=1.5) +
  geom_errorbar(position=position_dodge(width=0.9), aes(ymin=SV-ci, ymax=SV+ci), width=.2, size=1.25) +  
  geom_point(data = coged.SV, aes(x=task, y=meanSV),
             stat="identity", alpha=0.7) +
  geom_line(data = coged.SV, aes(x=task, y=meanSV, group=subID, colour = factor(subID)), alpha = .5) +
  coord_cartesian(ylim=c(0,1)) +
  xlab("Task") + ylab("Subjective Value") +
  facet_grid(MDD_Status ~ Age.Group)
p.SV.discounting <- p.SV.pt + guides(colour=FALSE)
p.SV.discounting
```

### COGED: Proportion of Hard Choice
```{r coged_fmri_hardchoice, eval = T, echo=F, warning=FALSE, message=FALSE, cache=T}
coged.fmri.hardChoice <- coged.fmri %>% select(subID, trialType, choseHard, MDD_Status,Age.Group) %>% 
  group_by(subID, trialType, MDD_Status,Age.Group) %>%
  summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
  mutate(propHard = n_hardChoice/n_choice)
coged.fmri.hardChoice.subj <- coged.fmri %>% select(subID, trialType, choseHard) %>% group_by(subID) %>%
   summarise(n_choice = n(), n_hardChoice = sum(choseHard)) %>%
   mutate(propHard = n_hardChoice/n_choice)
# The general proportion of hard choice is 0.49.
(coged.fmri.hardChoice.subj.sum <- coged.fmri.hardChoice.subj %>%
  summarise(meanPropHard = mean(propHard), sdPropHard = sd(propHard)))
# by group
(coged.fmri.hardChoice.group <- coged.fmri.hardChoice %>%
   group_by(MDD_Status,Age.Group) %>%
  summarise(meanPropHard = mean(propHard), sdPropHard = sd(propHard)))
#Summary with trial type included
coged.prophard.sum <- summarySEwithin2(data = coged.fmri.hardChoice, measurevar = "propHard", withinvars = c("MDD_Status","Age.Group"), idvar = "subID")
```
  

### COGED: Proximity
```{r coged_fmri_prox, eval = F, echo=F, warning=FALSE, message=FALSE, cache=T}
#Data frame for proximity analyses
coged.fmri.prox <- coged.fmri %>%
  mutate(Run = if_else(trial < 82, 1, if_else(trial > 117, 3, 2)),
         Trial = if_else(Run == 1, trial-45, if_else(Run == 2, trial-81, (trial-117))))%>%
  select(subID, Trial, Run, choice, proximityValue, choseHard,loadCode, rewardCode, Age_centered, groupCode, choiceRT,MDD_Status) %>% as_tibble()
coged.fmri.prox$subID <- as.factor(coged.fmri.prox$subID)
```

# Hypotheses testing

## H1: Cognitive Effort Discounting (SV Encoding) 

Model: multilevel linear model with subjective value (SV) as the dependent variable and task load (N-back level) as the independent variable. 

**Predictors:** <br>
- Main effect of N-back level (H1a)  <br>
- Interaction between N-back level and age (H1b). <br>
- Interaction between N-back level and MDD status (MDD vs. HC; H1c).  <br>
- Covariate: N-back accuracy during familiarization phase
```{r H1, warning=F, message=F, cache=T}
#H1a
SV <- lmer(data = coged.lab.SV, SV ~ taskCode + Age_centered + groupCode + acc + (1 + taskCode | subID))
summary(SV)
#H1b
SV.age <- lmer(data = coged.lab.SV, SV ~ taskCode*Age_centered + groupCode + acc + (1 + taskCode | subID))
summary(SV.age)
#H1c
SV.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode*groupCode + Age_centered + acc  + (1 + taskCode | subID))
summary(SV.MDD)
#Exploratory: age & MDD interaction. 
SV.age.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode*Age_centered*groupCode + acc + (1 + taskCode | subID))
summary(SV.age.MDD)

#Panel A: All participant, spaghetti plot
SV.plot <- get_datagrid(SV, by = c("taskCode","subID"), preserve_range = TRUE)
preds <- estimate_relation(SV, include_random = T, data = SV.plot)

SV.plot.fixed <- get_datagrid(SV, by = c("taskCode"), preserve_range = TRUE)
fixed_pred <- estimate_relation(SV, at = "taskCode", data = SV.plot.fixed)
fig4A <- ggplot(fixed_pred, aes(x=taskCode, y=Predicted)) + 
  geom_line(data = preds, aes(x=taskCode, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "N-back Task Load", y="Subjective Value") +
  geom_ribbon(data = fixed_pred, aes(x = taskCode, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = taskCode, y = Predicted), linewidth = 1.5) +
  scale_x_continuous(breaks = -1:1, labels = 2:4) +
  guides(colour=FALSE) 
fig4A

#Panel B & C
ef <- effects::effect("taskCode*Age_centered*groupCode", 
             mod = SV.age.MDD, 
             xlevels = list(Age_centered = c(-1, 0, 1), groupCode =c(0,1) ))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig4BC <- ggplot(efdata, aes(x = taskCode, y = fit, color = Age_centered, group = Age_centered)) + 
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) + 
  facet_wrap(~ groupCode) +
  scale_x_continuous(breaks = -1:1, labels = 2:4) +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "N-back Task Load", y = "Subjective Value", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines"))
fig4BC

# Follow up analysis: only look at MDD/HC participants, what's the age x load interaction?
coged.sv.HConly <- coged.lab.SV %>% 
  filter(MDD_Status == "HC")
coged.sv.MDDonly <- coged.lab.SV %>% 
  filter(MDD_Status == "MDD")

SV.HConly.age <- lmer(data = coged.sv.HConly, SV ~ taskCode*Age_centered + acc + (1 + taskCode | subID))
summary(SV.HConly.age)
SV.MDDonly.age <- lmer(data = coged.sv.MDDonly, SV ~ taskCode*Age_centered + acc + (1 + taskCode | subID))
summary(SV.MDDonly.age)


# Follow up analysis: accuracy three way interaction predicting SV
SV.acc.age <- lmer(data = coged.lab.SV, SV ~ taskCode + groupCode + acc*Age_centered + (1 + taskCode | subID))
summary(SV.acc.age)
SV.acc.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode + Age_centered + acc*groupCode + (1 + taskCode | subID))
summary(SV.acc.MDD)
SV.acc.age.MDD <- lmer(data = coged.lab.SV, SV ~ taskCode + acc*Age_centered*groupCode + (1 + taskCode | subID))
summary(SV.acc.age.MDD)

# Follow up analysis: only look at MDD/HC participants, what's the age x acc interaction?
SV.HConly.age.acc <- lmer(data = coged.sv.HConly, SV ~ acc*Age_centered + taskCode + (1 + taskCode | subID))
summary(SV.HConly.age.acc)
SV.MDDonly.age.acc <- lmer(data = coged.sv.MDDonly, SV ~ acc*Age_centered + taskCode + (1 + taskCode | subID))
summary(SV.MDDonly.age.acc)

#Panel A: All participant, spaghetti plot
SV.acc.plot <- get_datagrid(SV, by = c("acc","subID"), preserve_range = TRUE)
preds <- estimate_relation(SV, include_random = T, data = SV.acc.plot)

SV.acc.plot.fixed <- get_datagrid(SV, by = c("acc"), preserve_range = TRUE)
fixed_pred <- estimate_relation(SV, at = "acc", data = SV.acc.plot.fixed)
fig5A <- ggplot(fixed_pred, aes(x=acc, y=Predicted)) + 
  geom_line(data = preds, aes(x=acc, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "N-back Accuracy", y="Subjective Value") +
  geom_ribbon(data = fixed_pred, aes(x = acc, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = acc, y = Predicted), linewidth = 1.5) +
  guides(colour=FALSE) 

#Panel B & C
ef <- effects::effect("acc*Age_centered*groupCode", 
             mod = SV.acc.age.MDD, 
             xlevels = list(Age_centered = c(-1, 0, 1), groupCode =c(0,1) ))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig5BC <- ggplot(efdata, aes(x = acc, y = fit, color = Age_centered, group = Age_centered)) + 
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) + 
  facet_wrap(~ groupCode)  +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "N-back Accuracy", y = "Subjective Value", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines"))
fig5A; fig5BC
```

## H2: Proximity Effect on Choice Behavior

Model: Logistic regression predicting choice of the higher-effort option as a function of proximity. 

**Predictors:** <br>
- Main effect of proximity (H2a). <br>
- Interaction between proximity and age (H2b). <br>
- Interaction between proximity and MDD status (H2c). <br>
```{r H2, warning=F, message=F, cache=T}
#H2a: as hypothesized: As proximity increases, people are biased to choose the harder option.
prox.choice <- glmer(data = coged.fmri.prox, choseHard ~ proximityValue + rewardCode + loadCode + Age_centered + groupCode + (1 + proximityValue|subID), family = "binomial")
summary(prox.choice)
#H2b: Older participants are less influenced by proximityValue when making their choice (p = .0009).
prox.choice.age <- glmer(data = coged.fmri.prox, choseHard ~ proximityValue*Age_centered + groupCode + rewardCode + loadCode+ (1+proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age)
#H2c: MDD interaction N.S.
prox.choice.MDD <- glmer(data = coged.fmri.prox, choseHard ~ proximityValue*groupCode + Age_centered + rewardCode + loadCode+ (1+proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.MDD)
#Exploratory: age & MDD interaction. The original model has a lot of convergence issue, so I centered the age variable. No significant interaction.
prox.choice.age.MDD <- glmer(data = coged.fmri.prox, choseHard ~ proximityValue*Age_centered*groupCode + rewardCode + loadCode + (1+proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age.MDD)

#Panel A
prox.choice.plot <- get_datagrid(prox.choice, by = c("proximityValue","subID"), preserve_range = TRUE)
preds <- estimate_relation(prox.choice, include_random = T, data = prox.choice.plot)

prox.choice.plot.fixed <- get_datagrid(prox.choice, by = c("proximityValue"), preserve_range = TRUE)
fixed_pred <- estimate_relation(prox.choice, at = "proximityValue", data = prox.choice.plot.fixed)
fig6A <- ggplot(fixed_pred, aes(x=proximityValue, y=Predicted)) + 
  geom_ribbon(data = fixed_pred, aes(x = proximityValue, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = proximityValue, y = Predicted), linewidth = 2) +
  geom_line(data = preds, aes(x=proximityValue, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) + theme_classic() + labs(x= "Relative Subjective Value of High-Effort Option", y="Proabability of Choosing the High-Effort Option") + 
  guides(colour=FALSE) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")
fig6A

#Panel B & C
ef <- effects::effect("proximityValue*Age_centered*groupCode", 
             mod = prox.choice.age.MDD, 
             xlevels = list(proximityValue = 15, Age_centered = c(-1, 0, 1), groupCode =c(0,1)))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig6BC <- ggplot(efdata, aes(x = proximityValue, y = fit, color = Age_centered)) + 
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) + 
  facet_wrap(~ groupCode)  +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "Relative Subjective Value of High-Effort Option", y = "Proabability of Choosing the High-Effort Option", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines")) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")
fig6BC

# Follow up analysis: age interaction in only MDD and HC group
prox.choice.MDDonly <- coged.fmri.prox %>% 
  filter(MDD_Status == "MDD")
prox.choice.HConly <- coged.fmri.prox %>% 
  filter(MDD_Status == "HC")
prox.choice.age.MDDonly <- glmer(data = prox.choice.MDDonly, choseHard ~ proximityValue*Age_centered + rewardCode + loadCode+ (1+proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age.MDDonly)
prox.choice.age.HConly <- glmer(data = prox.choice.HConly, choseHard ~ proximityValue*Age_centered + rewardCode + loadCode+ (1+proximityValue|subID), control = glmerControl(optimizer = "bobyqa"), family = "binomial")
summary(prox.choice.age.HConly)
```

## H3: Decision Difficulty proximity² on RT 

Model: Linear mixed-effects model predicting reaction time (RT) with proximity² as the independent variable. 

**Predictors:** <br>
- Main effect of proximity² (H2a). <br>
- Interaction between proximity² and age (H3b).  <br>
- Interaction between proximity² and MDD status (H2c). <br>
```{r H3, warning=F, message=F, cache=T}
#H3a: proximity² did not significantly predict RT
prox.RT <- lmer(data = coged.fmri.prox, choiceRT ~ I(proximityValue^2) + Age_centered + groupCode + (I(proximityValue^2)|subID))
summary(prox.RT)
#H2b: In older adults, the negative effect of proximity² on RT is weaker.
prox.RT.age <- lmer(data = coged.fmri.prox, choiceRT ~ I(proximityValue^2)*Age_centered + groupCode + (I(proximityValue^2)|subID))
summary(prox.RT.age)
#H2c: MDD interaction N.S.
prox.RT.MDD <- lmer(data = coged.fmri.prox, choiceRT ~ I(proximityValue^2)*groupCode + Age_centered + (I(proximityValue^2)|subID))
summary(prox.RT.MDD)
#Exploratory: age & MDD interaction. N.S.
prox.RT.age.MDD <- lmer(data = coged.fmri.prox, choiceRT ~ I(proximityValue^2)*Age_centered*groupCode + (I(proximityValue^2)|subID))
summary(prox.RT.age.MDD)

#Look at MDD and HC separately; age effect significant in MDD, not in healthy controls
prox.RT.age.MDDonly <- lmer(data = prox.choice.MDDonly, choiceRT ~ I(proximityValue^2)*Age_centered + (I(proximityValue^2)|subID))
summary(prox.RT.age.MDDonly)
prox.RT.age.HConly <- lmer(data = prox.choice.HConly, choiceRT ~ I(proximityValue^2)*Age_centered + (I(proximityValue^2)|subID))
summary(prox.RT.age.HConly)

#Visualize
d.prox.RT.plot <- get_datagrid(prox.RT, by = c("proximityValue","subID"), preserve_range = TRUE)
preds <- estimate_relation(prox.RT, include_random = T, data = d.prox.RT.plot)

d.prox.RT.plot.fixed <- get_datagrid(prox.RT, by = c("proximityValue"), preserve_range = TRUE)
fixed_pred <- estimate_relation(prox.RT, at = "proximityValue", data = d.prox.RT.plot.fixed)

fig7A <- ggplot(fixed_pred, aes(x=proximityValue, y=Predicted)) + 
  geom_ribbon(data = fixed_pred, aes(x = proximityValue, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = fixed_pred, aes(x = proximityValue, y = Predicted), linewidth = 2) +
  geom_line(data = preds, aes(x=proximityValue, y=Predicted, group=subID, colour = factor(subID)), alpha=0.5) +
  theme_classic() + 
  labs(x= "Proximity", y="Reaction Time (s)") +
  guides(colour=F)
fig7A

ef <- effects::effect("I(proximityValue^2)*Age_centered*groupCode", 
             mod = prox.RT.age.MDD, 
             xlevels = list(proximityValue = 30, Age_centered = c(-1, 0, 1), groupCode =c(0,1)))
efdata <- as.data.frame(ef)
efdata$groupCode <- factor(efdata$groupCode, levels = c(0,1), labels = c("HC", "MDD"))
efdata$Age_centered <-  factor(efdata$Age_centered, levels = c(-1,0,1), labels = age_lvls)
fig7BC <- ggplot(efdata, aes(x = proximityValue, y = fit, color = Age_centered)) + 
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se, fill = Age_centered), alpha = 0.3) + 
  facet_wrap(~ groupCode)  +
  scale_color_manual(values = cols3, breaks = age_lvls, drop = FALSE,
                     aesthetics = c("colour","fill")) +
  labs(x = "Proximity", y = "Reaction Time (s)", color = "Age", fill = "Age") +
  theme_classic() +
  theme(panel.spacing = unit(3, "lines")) 
fig7BC
```

```{r figdisplay, fig.width=10, fig.height=5}
fig2BC
fig3BC
fig4BC
fig5BC
fig6BC
fig7BC
```
